{% load static %}
<!DOCTYPE html>
<html lang="en" data-theme="{{ request.user.profile.theme|default:'dark' }}">


<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description"
        content="Never forget again! Manage tasks with recurring reminders, templates, and achievements.">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Quantum Manager">

    <!-- PWA Manifest -->
    <link rel="manifest" href="{% static 'tasks/manifest.json' %}">

    <!-- App Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="{% static 'tasks/icons/icon-192x192.png' %}">
    <link rel="apple-touch-icon" href="{% static 'tasks/icons/icon-192x192.png' %}">

    <!-- üëá NEW! Open Graph Meta Tags (Facebook, LinkedIn) -->
    <meta property="og:title" content="Quantumnager - Never Forget Again">
    <meta property="og:description"
        content="A beautiful task manager with recurring tasks, templates, achievements, and voice input. Stay productive and never forget important tasks!">
    <meta property="og:image" content="{% static 'tasks/icons/icon-512x512.png' %}">
    <meta property="og:url" content="{{ request.build_absolute_uri }}">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="Quantum Manager">

    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Quantum Manager - Never Forget Again">
    <meta name="twitter:description" content="Stay productive with recurring tasks, templates, and achievements!">
    <meta name="twitter:image" content="{% static 'tasks/icons/icon-512x512.png' %}">

    <!-- Additional SEO -->
    <meta name="keywords"
        content="quantum, querySelector manager, productivity, recurring tasks, templates, achievements, voice input">
    <meta name="author" content="Quantum Manager">

    <title>{% block title %}Quantum Manager{% endblock %}</title>
    <link rel="stylesheet" href="{% static 'tasks/style.css' %}">
    {% block extra_css %}{% endblock %}


    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/static/tasks/sw.js')
                    .then(registration => {
                        console.log('‚úÖ Service Worker registered:', registration);
                    })
                    .catch(error => {
                        console.log('‚ùå Service Worker registration failed:', error);
                    });
            });
        }
    </script>
</head>

<body>

    <div id="installPrompt" class="install-prompt" style="display: none;">
        <div class="install-content">
            <div class="install-icon">üì±</div>
            <div class="install-text">
                <h3>Install Quantum Manager</h3>
                <p>Add to your home screen for quick access!</p>
            </div>
            <button id="installBtn" class="btn btn-primary btn-sm">Install</button>
            <button id="dismissInstall" class="btn btn-secondary btn-sm">Maybe Later</button>
        </div>
    </div>


    <!-- Toast Notifications Container -->
    <div class="toast-container" id="toastContainer">
        {% if messages %}
        {% for message in messages %}
        <div class="toast toast-{{ message.tags }} show" role="alert">
            <div class="toast-content">
                <span class="toast-message">{{ message }}</span>
                <button class="toast-close" onclick="this.parentElement.parentElement.remove()">‚úï</button>
            </div>
        </div>
        {% endfor %}
        {% endif %}
    </div>

    {% csrf_token %}
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <p class="loading-text">Processing...</p>
        </div>
    </div>

    <!-- Hamburger Menu Button (Fixed) -->
    <button class="hamburger-btn" id="hamburgerBtn" onclick="toggleSidebar()">
        <span></span>
        <span></span>
        <span></span>
    </button>

    <!-- Sidebar Navigation -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="user-profile">
                {% if request.user.profile.avatar %}
                <img src="{{ request.user.profile.get_avatar_url }}" alt="{{ request.user.username }}"
                    class="profile-avatar has-image">
                {% else %}

                <div class="user-avatar">
                    {{ request.user.username|upper|slice:":2"|default:"?" }}
                </div>
                {% endif %}
                <div class="avatar-badge1">
                    {% if request.user.profile.email_verified %}
                    <span class="verified-badge" title="Email Verified">‚úì</span>
                    {% else %}
                    <span class="unverified-badge" title="Email Not Verified">!</span>
                    {% endif %}
                </div>
                <div class="user-info">
                    <h3 class="user-name">{{ request.user.username }}</h3>
                    <p class="user-email">{{ request.user.email }}</p>
                </div>
            </div>
            <button class="sidebar-close" onclick="toggleSidebar()">‚úï</button>
        </div>
        <!--
        <div class="menu-theme-switcher">
            <button class="theme-toggle-btn" onclick="quickToggleTheme()" title="Toggle Theme">
                <span class="theme-icon-dark">üåô</span>
                <span class="theme-icon-light">‚òÄÔ∏è</span>
            </button>
        </div>
    -->
        <nav class="sidebar-nav">
            <a href="/" class="nav-item {% if request.path == '/' %}active{% endif %}">
                <span class="nav-icon">üìù</span>
                <span class="nav-text">My Tasks</span>
            </a>

            <a href="/notes/" class="nav-item {% if request.path == '/notes/' %}active{% endif %}">
                <span class="nav-icon">üìù</span>
                <span class="nav-text">Notes</span>
            </a>

            <a href="/notes/archived/" class="nav-item {% if '/notes/archived/' in request.path %}active{% endif %}">
                <span class="nav-icon">üì¶</span>
                <span class="nav-text">Archived Notes</span>
            </a>

            <a href="/templates/" class="nav-item {% if request.path == '/templates/' %}active{% endif %}">
                <span class="nav-icon">‚ú®</span>
                <span class="nav-text">Templates</span>
            </a>

            <a href="/dashboard/" class="nav-item {% if request.path == '/dashboard/' %}active{% endif %}">
                <span class="nav-icon">üìä</span>
                <span class="nav-text">Dashboard</span>
            </a>


            <a href="/achievements/" class="nav-item {% if request.path == '/achievements/' %}active{% endif %}">
                <span class="nav-icon">üèÜ</span>
                <span class="nav-text"> Achievements</span>
            </a>

            <a href="/profile/" class="nav-item {% if request.path == '/profile/' %}active{% endif %}">
                <span class="nav-icon">üë§</span>
                <span class="nav-text">Profile</span>
            </a>

            <a href="/settings/" class="nav-item {% if request.path == '/settings/' %}active{% endif %}">
                <span class="nav-icon">‚öôÔ∏è</span>
                <span class="nav-text">Settings</span>
            </a>
            <div class="nav-divider"></div>


            <a href="/logout/" class="nav-item logout">
                <span class="nav-icon">üö™</span>
                <span class="nav-text">Logout</span>
            </a>
            <div class="install-content" id="sidebarInstallSection" style="display: none;">
                <div class="install-ico">üì±</div>
                <div class="install-tex">
                    <h3>Install Quantum Manager</h3>
                    <p>Add to your home screen for quick access!</p>
                </div>
                <button id="sidebarInstallBtn" class="btn btn-primary btn-sm">Install</button>
            </div>
        </nav>

        <div class="sidebar-footer">
            <p class="app-version">Quantum Manager v1.0</p>
            <p class="tagline">Never forget again üíô</p>
        </div>
    </div>

    <!-- Sidebar Overlay (Dark background when menu open) -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

    <!-- Main Content Area -->
    <div class="main-content">
        {% block content %}
        {% endblock %}
    </div>

    <!-- Floating Action Button (FAB) -->
    {% if request.path == '/' %}
    <a href="/create/" class="fab" title="Create New Task">
        <span class="fab-icon">+</span>
        <span class="fab-pulse"></span>
    </a>


    {% elif '/notes/' in request.path %}
    <a href="/notes/create/" class="fab" title="Create New Note">
        <span class="fab-icon">+</span>
        <span class="fab-pulse"></span>
    </a>
    {% endif %}

    <!-- Base Scripts -->
    <script>
        // Toggle Sidebar
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            const hamburger = document.getElementById('hamburgerBtn');

            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
            hamburger.classList.toggle('active');

            // Prevent body scroll when sidebar is open
            if (sidebar.classList.contains('active')) {
                document.body.style.overflow = 'hidden';
            } else {
                document.body.style.overflow = '';
            }
        }

        // Close sidebar on ESC key
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                const sidebar = document.getElementById('sidebar');
                if (sidebar.classList.contains('active')) {
                    toggleSidebar();
                }
            }
        });

        // Auto-hide toasts after 5 seconds
        document.addEventListener('DOMContentLoaded', function () {
            const toasts = document.querySelectorAll('.toast');
            toasts.forEach(toast => {
                setTimeout(() => {
                    toast.style.animation = 'fadeOut 0.5s ease-in forwards';
                    setTimeout(() => toast.remove(), 500);
                }, 5000);
            });

            // Show loading overlay when form is submitted
            const forms = document.querySelectorAll('form');
            const loadingOverlay = document.getElementById('loadingOverlay');

            forms.forEach(form => {
                form.addEventListener('submit', function (e) {
                    if (loadingOverlay) {
                        loadingOverlay.classList.add('active');
                    }

                    const submitBtn = form.querySelector('button[type="submit"], input[type="submit"]');
                    if (submitBtn) {
                        submitBtn.classList.add('loading');
                        submitBtn.disabled = true;
                    }
                });
            });
        });


        function quickToggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

            // Apply theme immediately
            html.setAttribute('data-theme', newTheme);

            // Save to server (async)
            fetch('/api/update-theme/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ theme: newTheme })
            });
        }

        let deferredPrompt;
        const installPrompt = document.getElementById('installPrompt');
        const topInstallBtn = document.getElementById('installBtn'); // Popup button
        const sidebarInstallBtn = document.getElementById('sidebarInstallBtn'); // Sidebar button
        const sidebarInstallSection = document.getElementById('sidebarInstallSection');
        const dismissBtn = document.getElementById('dismissInstall');

        // Capture install prompt
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;

            // Show popup install prompt if not dismissed before
            if (!localStorage.getItem('installDismissed')) {
                if (installPrompt) installPrompt.style.display = 'block';
            }

            // ALWAYS show sidebar install button when app is installable
            if (sidebarInstallSection) {
                sidebarInstallSection.style.display = 'block';
            }
        });

        // Handle install for BOTH buttons
        async function handleInstall() {
            if (!deferredPrompt) {
                alert('‚ùå App is already installed or not available for installation.');
                return;
            }

            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;

            console.log(`User choice: ${outcome}`);

            if (outcome === 'accepted') {
                console.log('‚úÖ User accepted the install prompt');
                // Hide both install UIs
                if (installPrompt) installPrompt.style.display = 'none';
                if (sidebarInstallSection) sidebarInstallSection.style.display = 'none';
            }

            deferredPrompt = null;
        }

        // Attach install handler to TOP popup button
        if (topInstallBtn) {
            topInstallBtn.addEventListener('click', handleInstall);
        }

        // Attach install handler to SIDEBAR button
        if (sidebarInstallBtn) {
            sidebarInstallBtn.addEventListener('click', handleInstall);
        }

        // Dismiss popup button (doesn't affect sidebar button)
        if (dismissBtn) {
            dismissBtn.addEventListener('click', () => {
                if (installPrompt) installPrompt.style.display = 'none';
                localStorage.setItem('installDismissed', 'true');
                // Sidebar button still available!
            });
        }

        // Log when app is installed
        window.addEventListener('appinstalled', () => {
            console.log('‚úÖ Quantum Manager installed!');
            if (installPrompt) installPrompt.style.display = 'none';
            if (sidebarInstallSection) sidebarInstallSection.style.display = 'none';
        });



        class AlarmSystem {
            constructor() {
                this.checkInterval = null;
                this.audioContext = null;
                this.isPlaying = false;
                this.currentAlarm = null;
                this.notificationPermission = 'default';

                this.init();
            }

            async init() {
                // Request notification permission
                if ('Notification' in window) {
                    this.notificationPermission = await Notification.requestPermission();
                }

                // Initialize audio context on user interaction (required by browsers)
                document.addEventListener('click', () => {
                    if (!this.audioContext) {
                        this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    }
                }, { once: true });

                // Start checking for due tasks
                this.startChecking();

                // Listen for visibility change
                document.addEventListener('visibilitychange', () => {
                    if (!document.hidden) {
                        this.checkDueTasks();
                    }
                });
            }

            startChecking() {
                // Check immediately
                this.checkDueTasks();

                // Then check every 30 seconds
                this.checkInterval = setInterval(() => {
                    this.checkDueTasks();
                }, 30000);
            }

            stopChecking() {
                if (this.checkInterval) {
                    clearInterval(this.checkInterval);
                }
            }

            async checkDueTasks() {
                try {
                    const response = await fetch('/api/check-due-tasks/', {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });

                    const data = await response.json();

                    if (data.due_tasks && data.due_tasks.length > 0) {
                        console.log(`Found ${data.due_tasks.length} due tasks`);
                        data.due_tasks.forEach(task => {
                            this.triggerAlarm(task);
                        });
                    }
                } catch (error) {
                    console.error('Error checking due tasks:', error);
                }
            }

            triggerAlarm(task) {
                // Don't trigger if already playing
                if (this.isPlaying) return;

                // Check if task was already notified recently
                const notifiedTasks = JSON.parse(localStorage.getItem('notifiedTasks') || '{}');
                const taskKey = `task_${task.id}_${task.alarm_time}`;

                const now = Date.now();
                if (notifiedTasks[taskKey] && (now - notifiedTasks[taskKey] < 300000)) {
                    // Already notified within last 5 minutes
                    return;
                }

                // Mark as notified
                notifiedTasks[taskKey] = now;
                localStorage.setItem('notifiedTasks', JSON.stringify(notifiedTasks));

                // Clean old notifications
                this.cleanOldNotifications(notifiedTasks);

                // Show notification
                this.showNotification(task);

                // Play alarm sound
                this.playAlarmSound(task.alarm_tone || 'classic');

                // Show in-app alarm modal
                this.showAlarmModal(task);
            }

            cleanOldNotifications(notifiedTasks) {
                const oneDayAgo = Date.now() - (24 * 60 * 60 * 1000);
                const cleaned = {};

                for (let key in notifiedTasks) {
                    if (notifiedTasks[key] > oneDayAgo) {
                        cleaned[key] = notifiedTasks[key];
                    }
                }

                localStorage.setItem('notifiedTasks', JSON.stringify(cleaned));
            }

            showNotification(task) {
                if (this.notificationPermission !== 'granted') return;

                const priorityEmoji = {
                    'urgent': 'üö®',
                    'high': 'üî¥',
                    'medium': 'üü°',
                    'low': 'üü¢'
                };

                const notification = new Notification('‚è∞ Task Due!', {
                    body: `${priorityEmoji[task.priority]} ${task.title}`,
                    icon: '/static/tasks/icons/icon-192x192.png',
                    badge: '/static/tasks/icons/icon-96x96.png',
                    tag: `task-${task.id}`,
                    requireInteraction: true,
                    vibrate: [200, 100, 200],
                    data: { taskId: task.id }
                });

                notification.onclick = () => {
                    window.focus();
                    window.location.href = `/update/${task.id}/`;
                    notification.close();
                };
            }

            playAlarmSound(tone = 'classic') {
                this.isPlaying = true;

                // Check for custom tone in localStorage
                if (tone === 'custom') {
                    const customTone = localStorage.getItem('customAlarmTone');
                    if (customTone) {
                        this.playCustomSound(customTone);
                        return;
                    }
                }

                // Play default tones using Web Audio API
                if (!this.audioContext) {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }

                const context = this.audioContext;

                if (tone === 'classic') {
                    this.playClassicBeep(context);
                } else if (tone === 'chime') {
                    this.playSoftChime(context);
                } else if (tone === 'urgent') {
                    this.playUrgentAlert(context);
                }
            }

            playClassicBeep(context) {
                const times = [0, 0.3, 0.6, 1.2, 1.5, 1.8];

                times.forEach(time => {
                    const oscillator = context.createOscillator();
                    const gainNode = context.createGain();

                    oscillator.connect(gainNode);
                    gainNode.connect(context.destination);

                    oscillator.frequency.value = 800;
                    oscillator.type = 'square';

                    gainNode.gain.setValueAtTime(0.3, context.currentTime + time);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, context.currentTime + time + 0.2);

                    oscillator.start(context.currentTime + time);
                    oscillator.stop(context.currentTime + time + 0.2);
                });

                setTimeout(() => {
                    this.isPlaying = false;
                }, 2000);
            }

            playSoftChime(context) {
                const frequencies = [523.25, 659.25, 783.99];

                frequencies.forEach((freq, index) => {
                    const oscillator = context.createOscillator();
                    const gainNode = context.createGain();

                    oscillator.connect(gainNode);
                    gainNode.connect(context.destination);

                    oscillator.frequency.value = freq;
                    oscillator.type = 'sine';

                    const startTime = context.currentTime + (index * 0.1);

                    gainNode.gain.setValueAtTime(0.2, startTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + 1);

                    oscillator.start(startTime);
                    oscillator.stop(startTime + 1);
                });

                setTimeout(() => {
                    this.isPlaying = false;
                }, 1500);
            }

            playUrgentAlert(context) {
                const duration = 3;
                const oscillator = context.createOscillator();
                const gainNode = context.createGain();
                const lfo = context.createOscillator();
                const lfoGain = context.createGain();

                lfo.frequency.value = 5;
                lfoGain.gain.value = 100;

                lfo.connect(lfoGain);
                lfoGain.connect(oscillator.frequency);

                oscillator.connect(gainNode);
                gainNode.connect(context.destination);

                oscillator.frequency.value = 800;
                oscillator.type = 'sawtooth';
                gainNode.gain.value = 0.4;

                const now = context.currentTime;
                oscillator.start(now);
                lfo.start(now);

                oscillator.stop(now + duration);
                lfo.stop(now + duration);

                setTimeout(() => {
                    this.isPlaying = false;
                }, duration * 1000);
            }

            async playCustomSound(soundUrl) {
                try {
                    const audio = new Audio(soundUrl);
                    audio.volume = 0.7;
                    await audio.play();

                    audio.onended = () => {
                        this.isPlaying = false;
                    };
                } catch (error) {
                    console.error('Error playing custom sound:', error);
                    this.isPlaying = false;
                    this.playClassicBeep(this.audioContext);
                }
            }

            showAlarmModal(task) {
                const modal = document.createElement('div');
                modal.className = 'alarm-modal-overlay';
                modal.innerHTML = `
            <div class="alarm-modal">
                <div class="alarm-modal-header">
                    <div class="alarm-icon">‚è∞</div>
                    <h2 class="alarm-title">Task Due!</h2>
                </div>
                <div class="alarm-modal-body">
                    <div class="alarm-task-info">
                        <h3 class="alarm-task-title">${this.escapeHtml(task.title)}</h3>
                        ${task.description ? `<p class="alarm-task-desc">${this.escapeHtml(task.description)}</p>` : ''}
                        <div class="alarm-task-meta">
                            <span class="priority-badge priority-${task.priority}">
                                ${task.priority.toUpperCase()}
                            </span>
                            <span class="alarm-time">üìÖ Due: ${new Date(task.due_date).toLocaleString()}</span>
                        </div>
                    </div>
                </div>
                <div class="alarm-modal-actions">
                    <button onclick="alarmSystem.snoozeAlarm(${task.id}, 10)" class="alarm-btn alarm-btn-snooze">
                        ‚è∞ Snooze 10 min
                    </button>
                    <button onclick="alarmSystem.viewTask(${task.id})" class="alarm-btn alarm-btn-view">
                        üëÅÔ∏è View Task
                    </button>
                    <button onclick="alarmSystem.dismissAlarm()" class="alarm-btn alarm-btn-dismiss">
                        ‚úÖ Dismiss
                    </button>
                </div>
            </div>
        `;

                document.body.appendChild(modal);
                this.currentAlarm = modal;

                setTimeout(() => modal.classList.add('show'), 10);
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            async snoozeAlarm(taskId, minutes) {
                try {
                    const response = await fetch(`/api/snooze-alarm/${taskId}/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': this.getCookie('csrftoken')
                        },
                        body: JSON.stringify({ minutes })
                    });

                    if (response.ok) {
                        this.dismissAlarm();
                        this.showToast(`‚è∞ Snoozed for ${minutes} minutes`, 'info');
                    }
                } catch (error) {
                    console.error('Error snoozing alarm:', error);
                }
            }

            viewTask(taskId) {
                this.dismissAlarm();
                window.location.href = `/update/${taskId}/`;
            }

            dismissAlarm() {
                if (this.currentAlarm) {
                    this.currentAlarm.classList.remove('show');
                    setTimeout(() => {
                        this.currentAlarm.remove();
                        this.currentAlarm = null;
                    }, 300);
                }
            }

            showToast(message, type) {
                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                toast.textContent = message;
                toast.style.cssText = `
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            background: ${type === 'success' ? '#2ecc71' : type === 'warning' ? '#f39c12' : '#3498db'};
            color: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 10000;
            animation: slideIn 0.3s ease;
        `;

                document.body.appendChild(toast);

                setTimeout(() => {
                    toast.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }

            getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
        }

        // Initialize alarm system
        let alarmSystem;
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                alarmSystem = new AlarmSystem();
            });
        } else {
            alarmSystem = new AlarmSystem();
        }
    </script>


    {% block extra_js %}{% endblock %}
</body>

</html>