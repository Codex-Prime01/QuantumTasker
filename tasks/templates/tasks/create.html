{% extends 'tasks/base.html' %}
{% load static %}

{% block title %}Create Task - Todo Manager{% endblock %}

{% block content %}
<div class="create-task-container">
    <!-- Back Button -->
    <a href="/" class="back-button">
        <span>‚Üê</span>
        <span>Back to Tasks</span>
    </a>

    <!-- Create Task Card -->
    <div class="create-task-card">
        <div class="create-header">
            <div class="create-icon">‚ú®</div>
            <h1 class="create-title">Create New Task</h1>
            <p class="create-subtitle">Fill in the details below to create your task</p>
        </div>

        <form method="POST" class="create-form">
            {% csrf_token %}



            <div class="voice-input-section">
                <div class="voice-header">
                    <h3 class="voice-title">
                        <span class="voice-icon">üé§</span>
                        <span>Quick Capture</span>
                    </h3>
                    <p class="voice-subtitle">Speak to create a task hands-free!</p>
                </div>

                <div class="voice-controls">
                    <button type="button" id="voiceBtn" class="voice-button">
                        <span class="mic-icon">üé§</span>
                        <span class="voice-text">Click to Speak</span>
                    </button>

                    <div class="voice-status" id="voiceStatus">
                        <span class="status-text">Ready to listen...</span>
                    </div>
                </div>

                <div class="voice-tips">
                    <p class="tips-title">üí° Tips:</p>
                    <ul class="tips-list">
                        <li>Speak clearly and naturally</li>
                        <li>Example: "Buy groceries tomorrow at 5 PM"</li>
                        <li>Browser will ask for microphone permission</li>
                    </ul>
                </div>
            </div>

            <div class="form-divider">
                <span>OR</span>
            </div>


            <!-- Title Field -->
            <div class="form-group-create">
                <label for="id_title" class="form-label-create">
                    <span class="label-icon">üìù</span>
                    <span class="label-text">Task Title</span>
                    <span class="label-required">*</span>
                </label>
                {{ form.title }}
                {% if form.title.errors %}
                <div class="field-error">
                    {% for error in form.title.errors %}
                    <p>{{ error }}</p>
                    {% endfor %}
                </div>
                {% endif %}
            </div>

            <!-- Description Field -->
            <div class="form-group-create">
                <label for="id_description" class="form-label-create">
                    <span class="label-icon">üìÑ</span>
                    <span class="label-text">Description</span>
                    <span class="label-optional">(optional)</span>
                </label>
                {{ form.description }}
                <p class="field-hint">Add more details about this task</p>
            </div>

            <!-- Due Date & Priority Row -->
            <div class="form-row-create">
                <div class="form-group-create">
                    <label for="id_due_date" class="form-label-create">
                        <span class="label-icon">üìÖ</span>
                        <span class="label-text">Due Date</span>
                        <span class="label-optional">(optional)</span>
                    </label>
                    {{ form.due_date }}
                    <p class="field-hint">When should this be completed?</p>
                </div>

                <div class="form-group-create">
                    <label for="id_priority" class="form-label-create">
                        <span class="label-icon">‚ö°</span>
                        <span class="label-text">Priority</span>
                    </label>
                    {{ form.priority }}
                    <p class="field-hint">How important is this?</p>
                </div>
            </div>

            <!-- Categories Field -->
            <div class="form-group-create">
                <label class="form-label-create">
                    <span class="label-icon">üè∑Ô∏è</span>
                    <span class="label-text">Categories</span>
                    <!--<span class="label-optional">(optional)</span>-->
                </label>
                <div class="categories-grid">
                    {{ form.categories }}
                </div>
                <p class="field-hint">Select one or more categories</p>
            </div>


            <div class="form-group full-width recurring-section">
                <div class="recurring-header">
                    <label class="form-label">
                        <span class="label-icon">üîÑ</span>
                        <span>Recurring Task</span>
                    </label>
                    <label class="toggle-switch">
                        {{ form.is_recurring }}
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <p class="form-hint">{{ form.is_recurring.help_text }}</p>

                <div class="recurring-options" id="recurringOptions" style="display: none;">
                    <div class="form-group">
                        <label class="form-label" for="{{ form.recurring_frequency.id_for_label }}">
                            <span class="label-icon">üìÖ</span>
                            <span>{{ form.recurring_frequency.label }}</span>
                        </label>
                        {{ form.recurring_frequency }}
                        <p class="form-hint">{{ form.recurring_frequency.help_text }}</p>
                    </div>

                    <div class="form-group" id="customIntervalGroup" style="display: none;">
                        <label class="form-label" for="{{ form.recurring_interval.id_for_label }}">
                            <span class="label-icon">üî¢</span>
                            <span>{{ form.recurring_interval.label }}</span>
                        </label>
                        {{ form.recurring_interval }}
                        <p class="form-hint">{{ form.recurring_interval.help_text }}</p>
                    </div>

                    <div class="recurring-preview">
                        <p class="preview-text" id="recurringPreview">
                            <strong>Preview:</strong> <span id="previewText">Task will repeat daily</span>
                        </p>
                    </div>
                </div>
            </div>


            <!-- Action Buttons -->
            <div class="create-actions">
                <button type="submit" class="btn-create-submit">
                    <span class="btn-icon">‚úì</span>
                    <span class="btn-text">Create Task</span>
                </button>
                <a href="/" class="btn-create-cancel">
                    <span class="btn-icon">‚úï</span>
                    <span class="btn-text">Cancel</span>
                </a>
            </div>
        </form>
    </div>

    <!-- Quick Tips -->
    <div class="quick-tips">x
        <h3 class="tips-title">üí° Quick Tips</h3>
        <ul class="tips-list">
            <li>Use clear, actionable titles like "Call dentist" or "Buy groceries"</li>
            <li>Set realistic due dates to stay on track</li>
            <li>Higher priority tasks appear first in sorted lists</li>
            <li>Categories help you organize and filter tasks later</li>
        </ul>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const isRecurringToggle = document.getElementById('id_is_recurring');
        const recurringOptions = document.getElementById('recurringOptions');
        const frequencySelect = document.getElementById('id_recurring_frequency');
        const customIntervalGroup = document.getElementById('customIntervalGroup');
        const intervalInput = document.getElementById('id_recurring_interval');
        const previewText = document.getElementById('previewText');

        // Show/hide recurring options
        isRecurringToggle.addEventListener('change', function () {
            if (this.checked) {
                recurringOptions.style.display = 'block';
                updatePreview();
            } else {
                recurringOptions.style.display = 'none';
            }
        });

        // Show/hide custom interval
        frequencySelect.addEventListener('change', function () {
            if (this.value === 'custom') {
                customIntervalGroup.style.display = 'block';
            } else {
                customIntervalGroup.style.display = 'none';
            }
            updatePreview();
        });

        // Update preview on interval change
        intervalInput.addEventListener('input', updatePreview);

        // Update preview text
        function updatePreview() {
            const frequency = frequencySelect.value;
            const interval = intervalInput.value || 1;

            const previewMap = {
                'none': 'Task does not repeat',
                'daily': 'Task will repeat every day',
                'weekly': 'Task will repeat every week',
                'biweekly': 'Task will repeat every 2 weeks',
                'monthly': 'Task will repeat every month',
                'yearly': 'Task will repeat every year',
                'custom': `Task will repeat every ${interval} day${interval > 1 ? 's' : ''}`
            };

            previewText.textContent = previewMap[frequency] || 'Select a frequency';
        }

        // Check if recurring is already enabled (edit mode)
        if (isRecurringToggle.checked) {
            recurringOptions.style.display = 'block';
            if (frequencySelect.value === 'custom') {
                customIntervalGroup.style.display = 'block';
            }
            updatePreview();
        }
    });


    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

    if (SpeechRecognition) {
        const recognition = new SpeechRecognition();
        const voiceBtn = document.getElementById('voiceBtn');
        const voiceStatus = document.getElementById('voiceStatus');
        const titleInput = document.getElementById('id_title');

        // Configure recognition
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.lang = 'en-US';

        let isListening = false;

        // Voice button click
        voiceBtn.addEventListener('click', function () {
            if (isListening) {
                recognition.stop();
            } else {
                recognition.start();
            }
        });

        // Recognition started
        recognition.onstart = function () {
            isListening = true;
            voiceBtn.classList.add('listening');
            voiceStatus.innerHTML = '<span class="status-text listening">üéôÔ∏è Listening... Speak now!</span>';
        };

        // Recognition ended
        recognition.onend = function () {
            isListening = false;
            voiceBtn.classList.remove('listening');
            voiceStatus.innerHTML = '<span class="status-text">Ready to listen...</span>';
        };

        // Recognition result
        recognition.onresult = function (event) {
            const transcript = event.results[0][0].transcript;
            console.log('Heard:', transcript);

            // Fill in the title field
            titleInput.value = transcript;

            // Try to parse natural language for due dates
            parseNaturalLanguage(transcript);

            // Show success
            voiceStatus.innerHTML = '<span class="status-text success">‚úÖ Got it: "' + transcript + '"</span>';

            // Reset after 3 seconds
            setTimeout(() => {
                voiceStatus.innerHTML = '<span class="status-text">Ready to listen...</span>';
            }, 3000);
        };

        // Recognition error
        recognition.onerror = function (event) {
            console.error('Speech recognition error:', event.error);

            let errorMessage = 'Error occurred. Please try again.';

            if (event.error === 'no-speech') {
                errorMessage = '‚ùå No speech detected. Try again!';
            } else if (event.error === 'not-allowed') {
                errorMessage = '‚ùå Microphone access denied. Check browser permissions.';
            } else if (event.error === 'network') {
                errorMessage = '‚ùå Network error. Check your connection.';
            }

            voiceStatus.innerHTML = '<span class="status-text error">' + errorMessage + '</span>';

            setTimeout(() => {
                voiceStatus.innerHTML = '<span class="status-text">Ready to listen...</span>';
            }, 4000);
        };

        // Parse natural language for dates and priority
        function parseNaturalLanguage(text) {
            const lowerText = text.toLowerCase();

            // Check for priority keywords
            if (lowerText.includes('urgent') || lowerText.includes('asap') || lowerText.includes('emergency')) {
                document.getElementById('id_priority').value = 'urgent';
            } else if (lowerText.includes('important') || lowerText.includes('high priority')) {
                document.getElementById('id_priority').value = 'high';
            } else if (lowerText.includes('low priority') || lowerText.includes('whenever')) {
                document.getElementById('id_priority').value = 'low';
            }

            // Check for time-based keywords (basic parsing)
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(9, 0, 0, 0); // Default to 9 AM

            const nextWeek = new Date();
            nextWeek.setDate(nextWeek.getDate() + 7);
            nextWeek.setHours(9, 0, 0, 0);

            if (lowerText.includes('tomorrow')) {
                setDateTimeInput(tomorrow);
            } else if (lowerText.includes('next week')) {
                setDateTimeInput(nextWeek);
            } else if (lowerText.includes('today')) {
                const today = new Date();
                today.setHours(17, 0, 0, 0); // Default to 5 PM today
                setDateTimeInput(today);
            }
        }

        // Helper to set datetime input
        function setDateTimeInput(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');

            const dateTimeString = `${year}-${month}-${day}T${hours}:${minutes}`;
            document.getElementById('id_due_date').value = dateTimeString;
        }

    } else {
        // Browser doesn't support speech recognition
        const voiceSection = document.querySelector('.voice-input-section');
        voiceSection.innerHTML = `
        <div class="voice-not-supported">
            <p>üé§ Voice input is not supported in this browser.</p>
            <p>Try Chrome, Edge, or Safari for voice input!</p>
        </div>
    `;
    }

</script>
{% endblock %}