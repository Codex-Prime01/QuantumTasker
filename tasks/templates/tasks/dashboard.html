{% extends 'tasks/base.html' %}
{% load static %}

{% block title %}Dashboard - Todo Manager{% endblock %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
{% endblock %}

{% block content %}
<div class="container">
    <header class="page-header">
        <h1 class="page-title">
            <span class="glow">Analytics</span> Dashboard
        </h1>
    </header>

    <!-- Overall Stats Grid -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">ğŸ“‹</div>
            <div class="stat-info">
                <div class="stat-value">{{ total_tasks }}</div>
                <div class="stat-label">Total Tasks</div>
            </div>
        </div>

        <div class="stat-card completed">
            <div class="stat-icon">âœ…</div>
            <div class="stat-info">
                <div class="stat-value">{{ completed_tasks }}</div>
                <div class="stat-label">Completed</div>
            </div>
        </div>

        <div class="stat-card pending">
            <div class="stat-icon">â³</div>
            <div class="stat-info">
                <div class="stat-value">{{ pending_tasks }}</div>
                <div class="stat-label">Pending</div>
            </div>
        </div>

        <div class="stat-card rate">
            <div class="stat-icon">ğŸ“ˆ</div>
            <div class="stat-info">
                <div class="stat-value">{{ completion_rate }}%</div>
                <div class="stat-label">Completion Rate</div>
            </div>
        </div>
    </div>

    <!-- Warning Cards -->
    {% if overdue_count > 0 %}
    <div class="warning-card overdue">
        <span class="warning-icon">ğŸš¨</span>
        <span class="warning-text">You have <strong>{{ overdue_count }}</strong>
            overdue task{{ overdue_count|pluralize }}</span>
        <a href="/?sort=due_date" class="warning-action">View â†’</a>
    </div>
    {% endif %}

    <!-- Charts Section -->
    <div class="charts-grid">
        <!-- Priority Breakdown Chart -->
        <div class="chart-card">
            <h3 class="chart-title">ğŸ“Š Tasks by Priority</h3>
            <canvas id="priorityChart"></canvas>
        </div>

        <!-- Category Distribution Chart -->
        {% if category_stats %}
        <div class="chart-card">
            <h3 class="chart-title">ğŸ“š Tasks by Category</h3>
            <canvas id="categoryChart"></canvas>
        </div>
        {% endif %}
    </div>

    <!-- Upcoming Deadlines -->
    {% if upcoming_tasks %}
    <div class="dashboard-section">
        <h3 class="section-title">ğŸ“… Upcoming Deadlines (Next 7 Days)</h3>
        <div class="upcoming-list">
            {% for task in upcoming_tasks %}
            <div class="upcoming-item">
                <div class="upcoming-info">
                    <h4 class="upcoming-title">{{ task.title }}</h4>
                    <span class="upcoming-date">{{ task.due_date|date:"M d, Y h:i A" }}</span>
                </div>
                <span class="priority-badge priority-{{ task.priority }}">
                    {{ task.get_priority_display }}
                </span>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Recent Activity -->
    {% if recent_completed %}
    <div class="dashboard-section">
        <h3 class="section-title">âœ¨ Recently Completed</h3>
        <div class="recent-list">
            {% for task in recent_completed %}
            <div class="recent-item">
                <span class="recent-icon">âœ“</span>
                <span class="recent-title">{{ task.title }}</span>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Weekly Stats -->
    <div class="weekly-stats">
        <div class="weekly-card">
            <span class="weekly-icon">ğŸ“</span>
            <div class="weekly-info">
                <div class="weekly-value">{{ tasks_this_week }}</div>
                <div class="weekly-label">Created This Week</div>
            </div>
        </div>
        <div class="weekly-card">
            <span class="weekly-icon">âœ…</span>
            <div class="weekly-info">
                <div class="weekly-value">{{ completed_this_week }}</div>
                <div class="weekly-label">Completed This Week</div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js Configuration -->
<script>
    // Priority Pie Chart
    const priorityCtx = document.getElementById('priorityChart').getContext('2d');
    new Chart(priorityCtx, {
        type: 'doughnut',
        data: {
            labels: ['Urgent', 'High', 'Medium', 'Low'],
            datasets: [{
                data: [
                    {{ priority_stats.urgent }},
            {{ priority_stats.high }},
                        {{ priority_stats.medium }},
        {{ priority_stats.low }}
                    ],
        backgroundColor: [
        '#9C27B0',  // Urgent - Purple
        '#F44336',  // High - Red
        '#FFC107',  // Medium - Yellow
        '#4CAF50'   // Low - Green
    ],
        borderColor: 'rgba(0, 0, 0, 0.8)',
        borderWidth: 2
                }]
            },
        options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    color: '#fff',
                    font: {
                        size: 14,
                        family: 'Rajdhani'
                    },
                    padding: 15
                }
            }
        }
    }
        });

    {% if category_stats %}
    // Category Bar Chart
    const categoryCtx = document.getElementById('categoryChart').getContext('2d');
    new Chart(categoryCtx, {
        type: 'bar',
        data: {
            labels: [{% for cat in category_stats %}'{{ cat.name }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
        datasets: [{
            label: 'Tasks',
            data: [{% for cat in category_stats %}{{ cat.count }}{% if not forloop.last %}, {% endif %} {% endfor %}],
    backgroundColor: [{% for cat in category_stats %}'{{ cat.color }}'{% if not forloop.last %}, {% endif %} {% endfor %}],
    borderColor: 'rgba(0, 0, 0, 0.8)',
        borderWidth: 2
                }]
            },
    options: {
        responsive: true,
            maintainAspectRatio: true,
                plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                    ticks: {
                    color: '#fff',
                        font: {
                        family: 'Rajdhani'
                    },
                    stepSize: 1
                },
                grid: {
                    color: 'rgba(255, 255, 255, 0.1)'
                }
            },
            x: {
                ticks: {
                    color: '#fff',
                        font: {
                        family: 'Rajdhani'
                    }
                },
                grid: {
                    display: false
                }
            }
        }
    }
        });
    {% endif %}


    // Show loading overlay when form is submitted
    document.addEventListener('DOMContentLoaded', function () {
        const forms = document.querySelectorAll('form');
        const loadingOverlay = document.getElementById('loadingOverlay');

        forms.forEach(form => {
            form.addEventListener('submit', function (e) {
                // Show loading overlay
                if (loadingOverlay) {
                    loadingOverlay.classList.add('active');
                }

                // Add loading class to submit button
                const submitBtn = form.querySelector('button[type="submit"], input[type="submit"]');
                if (submitBtn) {
                    submitBtn.classList.add('loading');
                    submitBtn.disabled = true;
                }
            });
        });

        // Auto-hide toasts after 5 seconds
        const toasts = document.querySelectorAll('.toast');
        toasts.forEach(toast => {
            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.5s ease-in forwards';
                setTimeout(() => toast.remove(), 500);
            }, 5000);
        });
    });
</script>
{% endblock %}