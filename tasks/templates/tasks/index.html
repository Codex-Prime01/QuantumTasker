{% extends 'tasks/base.html' %}
{% load static %}

{% block title %}My Tasks - Todo Manager{% endblock %}

{% block content %}
<div class="container">
    <!-- Page Header -->
    <header class="page-header">
        <h1 class="page-title">
            <span class="glow">My</span> Tasks
        </h1>
    </header>

    <!-- Search Bar -->
    <div class="search-container">
        <form action="/" method="GET" class="search-form">
            {% if selected_category %}
            <input type="hidden" name="category" value="{{ selected_category.id }}">
            {% endif %}
            {% if sort_by %}
            <input type="hidden" name="sort" value="{{ sort_by }}">
            {% endif %}
            {% if order %}
            <input type="hidden" name="order" value="{{ order }}">
            {% endif %}

            <div class="search-input-wrapper">
                <span class="search-icon">üîç</span>
                <input type="text" name="search" class="search-input"
                    placeholder="Search tasks by title or description..." value="{{ search_query }}" autocomplete="off">
                {% if search_query %}
                <a href="/" class="clear-search" title="Clear search">‚úï</a>
                {% endif %}
            </div>

            <button type="submit" class="search-btn">
                <span>Search</span>
            </button>
        </form>

        {% if search_query %}
        <div class="search-results-info">
            <p>Found <strong>{{ tasks.count }}</strong> result{{ tasks.count|pluralize }} for "<strong>
                    {{ search_query }}</strong>"</p>
        </div>
        {% endif %}
    </div>

    <!-- Stats Container -->
    <div class="stats-container">
        <div class="stat-box">
            <span class="stat-number">{{ totalTasks }}</span>
            <span class="stat-label">Total Tasks</span>
        </div>
        <div class="stat-box">
            <span class="stat-number">{{ pending_count }}</span>
            <span class="stat-label">Pending</span>
        </div>
    </div>

    <!-- Category Filter Buttons -->
    <div class="filter-section">
        <h3 class="filter-title">Filter by Category</h3>
        <div class="filter-buttons">
            <a href="/" class="filter-btn {% if not selected_category %}active{% endif %}">
                <span>üåü</span>
                <span>All Tasks</span>
                <span class="filter-count">{{ total_tasks }}</span>
            </a>

            {% for category in categories %}
            <a href="?category={{ category.id }}"
                class="filter-btn {% if selected_category.id == category.id %}active{% endif %}"
                style="--filter-color: {{ category.color }};">
                <span>‚óè</span>
                <span>{{ category.name }}</span>
                <span class="filter-count">{{ category.task_count }}</span>
            </a>
            {% endfor %}
        </div>
    </div>

    <!-- Sort Section -->
    <div class="sort-section">
        <h3 class="sort-title">Sort Tasks</h3>
        <div class="sort-buttons">
            <a href="?{% if selected_category %}category={{ selected_category.id }}&{% endif %}sort=created&order={% if sort_by == 'created' and order == 'desc' %}asc{% else %}desc{% endif %}"
                class="sort-btn {% if sort_by == 'created' %}active{% endif %}">
                <span>üïê</span>
                <span>Created</span>
                {% if sort_by == 'created' %}
                <span class="sort-arrow">{% if order == 'desc' %}‚ñº{% else %}‚ñ≤{% endif %}</span>
                {% endif %}
            </a>

            <a href="?{% if selected_category %}category={{ selected_category.id }}&{% endif %}sort=due_date&order={% if sort_by == 'due_date' and order == 'asc' %}desc{% else %}asc{% endif %}"
                class="sort-btn {% if sort_by == 'due_date' %}active{% endif %}">
                <span>üìÖ</span>
                <span>Due Date</span>
                {% if sort_by == 'due_date' %}
                <span class="sort-arrow">{% if order == 'asc' %}‚ñ≤{% else %}‚ñº{% endif %}</span>
                {% endif %}
            </a>

            <a href="?{% if selected_category %}category={{ selected_category.id }}&{% endif %}sort=priority&order=asc"
                class="sort-btn {% if sort_by == 'priority' %}active{% endif %}">
                <span>‚ö°</span>
                <span>Priority</span>
                {% if sort_by == 'priority' %}
                <span class="sort-arrow">‚ñº</span>
                {% endif %}
            </a>

            <a href="?{% if selected_category %}category={{ selected_category.id }}&{% endif %}sort=title&order={% if sort_by == 'title' and order == 'asc' %}desc{% else %}asc{% endif %}"
                class="sort-btn {% if sort_by == 'title' %}active{% endif %}">
                <span>üî§</span>
                <span>A-Z</span>
                {% if sort_by == 'title' %}
                <span class="sort-arrow">{% if order == 'asc' %}‚ñ≤{% else %}‚ñº{% endif %}</span>
                {% endif %}
            </a>
        </div>
    </div>

    <!-- Tasks List -->
    <div class="tasks-list">
        {% for task in tasks %}
        <div class="task-item {% if task.complete %}completed{% endif %} {% if task.is_overdue %}overdue{% endif %}">
            <div class="task-content">
                <div class="task-header" onclick="toggleDescription({{ task.id }})">
                    <div class="task-title-row">
                        {% if task.complete %}
                        <h4 class="task-title completed-title">
                            {{ task.title }}
                            {% if task.description %}
                            <span class="has-description-badge" title="Has description">üìÑ</span>
                            {% endif %}
                        </h4>
                        {% else %}
                        <h4 class="task-title">
                            {{ task.title }}
                            {% if task.description %}
                            <span class="has-description-badge" title="Has description">üìÑ</span>
                            {% endif %}
                        </h4>
                        {% endif %}

                        {% if task.description %}
                        <span class="expand-icon" id="expand-icon-{{ task.id }}">‚ñº</span>
                        {% endif %}
                    </div>

                    <!-- Priority & Due Date Info -->
                    <div class="task-meta">
                        <span class="priority-badge priority-{{ task.priority }}">
                            {% if task.priority == 'urgent' %}‚ö°
                            {% elif task.priority == 'high' %}üî¥
                            {% elif task.priority == 'medium' %}üü°
                            {% else %}üü¢{% endif %}
                            {{ task.get_priority_display }}
                        </span>

                        {% if task.due_date %}
                        <span class="due-date-badge {% if task.is_overdue %}overdue-badge{% endif %}">
                            {% if task.is_overdue %}
                            üö® Overdue: {{ task.due_date|date:"M d, Y h:i A" }}
                            {% else %}
                            üìÖ Due: {{ task.due_date|date:"M d, Y h:i A" }}
                            {% endif %}
                        </span>
                        {% endif %}
                    </div>

                    <!-- Category Tags -->
                    {% if task.categories.all %}
                    <div class="task-categories">
                        {% for category in task.categories.all %}
                        <span class="category-tag" style="--tag-color: {{ category.color }};">
                            {{ category.name }}
                        </span>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>

                <!-- Task Description -->
                {% if task.description %}
                <div class="task-description" id="description-{{ task.id }}" style="display: none;">
                    <div class="description-content">
                        {{ task.description|linebreaks }}
                    </div>
                </div>
                {% endif %}
            </div>

            <div class="task-actions">
                <a href="{% url 'update' task.id %}" class="action-btn update-btn">
                    <span>‚úèÔ∏è</span>
                </a>
                <a href="{% url 'delete' task.id %}" class="action-btn delete-btn">
                    <span>üóëÔ∏è</span>
                </a>
            </div>
        </div>
        {% empty %}
        <div class="empty-state">
            {% if search_query %}
            <div class="no-results">
                <h3>üîç No results found</h3>
                <p>No tasks match "<strong>{{ search_query }}</strong>"</p>
                <a href="/" class="btn btn-update" style="margin-top: 20px; display: inline-flex;">
                    <span>Clear Search</span>
                </a>
            </div>
            {% else %}
            <div class="empty-tasks">
                <div class="empty-icon">‚ú®</div>
                <h3>No tasks yet!</h3>
                <p>Click the <strong>+</strong> button below to create your first task</p>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>

<script>
    function toggleDescription(taskId) {
        const description = document.getElementById(`description-${taskId}`);
        const icon = document.getElementById(`expand-icon-${taskId}`);

        if (description.style.display === 'none') {
            description.style.display = 'block';
            if (icon) icon.style.transform = 'rotate(180deg)';
        } else {
            description.style.display = 'none';
            if (icon) icon.style.transform = 'rotate(0deg)';
        }
    }
</script>
{% endblock %}