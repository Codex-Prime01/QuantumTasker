{% extends 'tasks/base.html' %}
{% load static %}

{% block title %}My Tasks - Todo Manager{% endblock %}

{% block content %}
<div class="container">
    {% csrf_token %}
    <!-- Page Header -->
    <header class="page-header">
        <h1 class="page-title">
            <span class="glow">My</span> Tasks
        </h1>
    </header>

    <!-- Streak Display -->
    {% if request.user.stats.current_streak > 0 %}
    <div class="streak-banner">
        <div class="streak-icon">ğŸ”¥</div>
        <div class="streak-info">
            <div class="streak-value">{{ request.user.stats.current_streak }} Day Streak!</div>
            <div class="streak-message">
                {% if request.user.stats.current_streak >= 7 %}
                You're on fire! Keep going! ğŸ”¥
                {% elif request.user.stats.current_streak >= 3 %}
                Great momentum! Don't break it! ğŸ’ª
                {% else %}
                Building a habit! Keep it up! âœ¨
                {% endif %}
            </div>
        </div>
        <a href="/achievements/" class="streak-link">View Achievements â†’</a>
    </div>
    {% endif %}

    <!-- Email Verification Banner -->
    {% if not request.user.profile.email_verified %}
    <div class="verification-banner">
        <div class="banner-content">
            <span class="banner-icon">âš ï¸</span>
            <span class="banner-text">
                Please verify your email to unlock all features!
            </span>
            <a href="/resend-verification/" class="banner-button">
                Verify Now
            </a>
        </div>
    </div>
    {% endif %}

    <!-- Search Bar -->
    <div class="search-container">
        <form action="/" method="GET" class="search-form">
            {% if selected_category %}
            <input type="hidden" name="category" value="{{ selected_category.id }}">
            {% endif %}
            {% if sort_by %}
            <input type="hidden" name="sort" value="{{ sort_by }}">
            {% endif %}
            {% if order %}
            <input type="hidden" name="order" value="{{ order }}">
            {% endif %}

            <div class="search-input-wrapper">
                <span class="search-icon">ğŸ”</span>
                <input type="text" name="search" class="search-input"
                    placeholder="Search tasks by title or description..." value="{{ search_query }}" autocomplete="off">
                {% if search_query %}
                <a href="/" class="clear-search" title="Clear search">âœ•</a>
                {% endif %}
            </div>

            <button type="submit" class="search-btn">
                <span>Search</span>
            </button>
        </form>

        {% if search_query %}
        <div class="search-results-info">
            <p>Found <strong>{{ tasks.count }}</strong> result{{ tasks.count|pluralize }} for "<strong>
                    {{ search_query }}</strong>"</p>
        </div>
        {% endif %}
    </div>

    <!-- Stats Container -->
    <div class="stats-container">
        <div class="stat-box">
            <span class="stat-number">{{ totalTasks }}</span>
            <span class="stat-label">Total </span>
        </div>
        <div class="stat-box">
            <span class="stat-number">{{ pending_count }}</span>
            <span class="stat-label">Pending</span>
        </div>
    </div>

    <!-- Category Filter Buttons -->
    <div class="filter-section">
        <h3 class="filter-title">Filter by Category</h3>
        <div class="filter-buttons">
            <a href="/" class="filter-btn {% if not selected_category %}active{% endif %}">
                <span>ğŸŒŸ</span>
                <span>All Tasks</span>
                <span class="filter-count">{{ total_tasks }}</span>
            </a>

            {% for category in categories %}
            <a href="?category={{ category.id }}"
                class="filter-btn {% if selected_category.id == category.id %}active{% endif %}"
                style="--filter-color: {{ category.color }};">
                <span>â—</span>
                <span>{{ category.name }}</span>
                <span class="filter-count">{{ category.task_count }}</span>
            </a>
            {% endfor %}
        </div>
    </div>

    <!-- Sort Section -->
    <div class="sort-section">
        <h3 class="sort-title">Sort Tasks</h3>
        <div class="sort-buttons">
            <a href="?{% if selected_category %}category={{ selected_category.id }}&{% endif %}sort=created&order={% if sort_by == 'created' and order == 'desc' %}asc{% else %}desc{% endif %}"
                class="sort-btn {% if sort_by == 'created' %}active{% endif %}">
                <span>ğŸ•</span>
                <span>Created</span>
                {% if sort_by == 'created' %}
                <span class="sort-arrow">{% if order == 'desc' %}â–¼{% else %}â–²{% endif %}</span>
                {% endif %}
            </a>

            <a href="?{% if selected_category %}category={{ selected_category.id }}&{% endif %}sort=due_date&order={% if sort_by == 'due_date' and order == 'asc' %}desc{% else %}asc{% endif %}"
                class="sort-btn {% if sort_by == 'due_date' %}active{% endif %}">
                <span>ğŸ“…</span>
                <span>Due Date</span>
                {% if sort_by == 'due_date' %}
                <span class="sort-arrow">{% if order == 'asc' %}â–²{% else %}â–¼{% endif %}</span>
                {% endif %}
            </a>

            <a href="?{% if selected_category %}category={{ selected_category.id }}&{% endif %}sort=priority&order=asc"
                class="sort-btn {% if sort_by == 'priority' %}active{% endif %}">
                <span>âš¡</span>
                <span>Priority</span>
                {% if sort_by == 'priority' %}
                <span class="sort-arrow">â–¼</span>
                {% endif %}
            </a>

            <a href="?{% if selected_category %}category={{ selected_category.id }}&{% endif %}sort=title&order={% if sort_by == 'title' and order == 'asc' %}desc{% else %}asc{% endif %}"
                class="sort-btn {% if sort_by == 'title' %}active{% endif %}">
                <span>ğŸ”¤</span>
                <span>A-Z</span>
                {% if sort_by == 'title' %}
                <span class="sort-arrow">{% if order == 'asc' %}â–²{% else %}â–¼{% endif %}</span>
                {% endif %}
            </a>
        </div>
    </div>

    <!-- Tasks List -->
    <div class="tasks-list">
        {% for task in tasks %}
        <div class="task-item {% if task.complete %}completed{% endif %} {% if task.is_overdue %}overdue{% endif %}">
            <div class="task-content">
                <div class="task-header" onclick="toggleDescription({{ task.id }})">
                    <div class="task-title-row">
                        <!-- Quick Complete Checkbox -->
                        <label class="task-checkbox-wrapper" onclick="event.stopPropagation();">
                            <input type="checkbox" class="task-checkbox" {% if task.complete %}checked{% endif %}
                                onchange="quickToggleComplete({{ task.id }}, this)">
                            <span class="checkbox-custom"></span>
                        </label>

                        {% if task.complete %}
                        <h4 class="task-title completed-title">
                            {{ task.title }}

                            {% if task.is_recurring and task.recurring_frequency != 'none' %}
                            <span class="recurring-badge" title="{{ task.get_recurring_info }}">
                                ğŸ”„
                            </span>
                            {% endif %}

                            {% if task.description %}
                            <span class="has-description-badge" title="Has description">ğŸ“„</span>
                            {% endif %}
                        </h4>
                        {% else %}
                        <h4 class="task-title">
                            {{ task.title }}
                            {% if task.description %}
                            <span class="has-description-badge" title="Has description">ğŸ“„</span>
                            {% endif %}
                        </h4>
                        {% endif %}

                        {% if task.description %}
                        <span class="expand-icon" id="expand-icon-{{ task.id }}">â–¼</span>
                        {% endif %}
                    </div>

                    <!-- Priority & Due Date Info -->
                    <div class="task-meta">
                        <span class="priority-badge priority-{{ task.priority }}">
                            {% if task.priority == 'urgent' %}âš¡
                            {% elif task.priority == 'high' %}ğŸ”´
                            {% elif task.priority == 'medium' %}ğŸŸ¡
                            {% else %}ğŸŸ¢{% endif %}
                            {{ task.get_priority_display }}
                        </span>

                        {% if task.due_date %}
                        <span class="due-date-badge {% if task.is_overdue %}overdue-badge{% endif %}">
                            {% if task.is_overdue %}
                            ğŸš¨ Overdue: {{ task.due_date|date:"M d, Y h:i A" }}
                            {% else %}
                            ğŸ“… Due: {{ task.due_date|date:"M d, Y h:i A" }}
                            {% endif %}
                        </span>
                        {% endif %}
                    </div>

                    {% if task.is_recurring and task.recurring_frequency != 'none' %}
                    <div class="task-recurring-info">
                        <span class="recurring-text">{{ task.get_recurring_info }}</span>
                    </div>
                    {% endif %}

                    <!-- Category Tags -->
                    {% if task.categories.all %}
                    <div class="task-categories">
                        {% for category in task.categories.all %}
                        <span class="category-tag" style="--tag-color: {{ category.color }};">
                            {{ category.name }}
                        </span>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>

                <!-- Task Description -->
                {% if task.description %}
                <div class="task-description" id="description-{{ task.id }}" style="display: none;">
                    <div class="description-content">
                        {{ task.description|linebreaks }}
                    </div>
                </div>
                {% endif %}
            </div>

            <div class="task-actions">
                <a href="{% url 'update' task.id %}" class="action-btn update-btn">
                    <span>âœï¸</span>
                </a>

                <button
                    onclick="shareTask({{ task.id }}, '{{ task.title|escapejs }}', '{{ task.get_priority_display }}')"
                    class="action-btn btn-share" title="Share">
                    <span>ğŸ”—</span>
                </button>

                <a href="{% url 'delete' task.id %}" class="action-btn delete-btn">
                    <span>ğŸ—‘ï¸</span>
                </a>
            </div>
        </div>
        {% empty %}
        <div class="empty-state">
            {% if search_query %}
            <div class="no-results">
                <h3>ğŸ” No results found</h3>
                <p>No tasks match "<strong>{{ search_query }}</strong>"</p>
                <a href="/" class="btn btn-update" style="margin-top: 20px; display: inline-flex;">
                    <span>Clear Search</span>
                </a>
            </div>
            {% else %}
            <div class="empty-tasks">
                <div class="empty-icon">âœ¨</div>
                <h3>No tasks yet!</h3>
                <p>Click the <strong>+</strong> button below to create your first task</p>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>

<script>
    function toggleDescription(taskId) {
        const description = document.getElementById(`description-${taskId}`);
        const icon = document.getElementById(`expand-icon-${taskId}`);

        if (description && icon) {
            if (description.style.display === 'none' || description.style.display === '') {
                description.style.display = 'block';
                icon.style.transform = 'rotate(180deg)';
            } else {
                description.style.display = 'none';
                icon.style.transform = 'rotate(0deg)';
            }
        }
    }


    // Quick toggle complete status
    function quickToggleComplete(taskId, checkbox) {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        fetch(`/quick-toggle/${taskId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const taskItem = checkbox.closest('.task-item');
                    const taskTitle = taskItem.querySelector('.task-title');

                    if (data.complete) {
                        taskItem.classList.add('completed');
                        taskTitle.classList.add('completed-title');
                        showToast('âœ… Task marked as complete!', 'success');
                    } else {
                        taskItem.classList.remove('completed');
                        taskTitle.classList.remove('completed-title');
                        showToast('ğŸ“ Task marked as incomplete!', 'info');
                    }

                    // Show achievement popup if unlocked
                    if (data.new_achievements && data.new_achievements.length > 0) {
                        showAchievementPopup(data.new_achievements);
                    }

                    // Show message for recurring tasks
                    if (data.message) {
                        showToast(data.message, 'success');
                        setTimeout(() => window.location.reload(), 2000);
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                checkbox.checked = !checkbox.checked;
                showToast('âŒ Failed to update task', 'error');
            });
    }

    // Show toast notification
    function showToast(message, type = 'info') {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast toast-${type} show`;
        toast.innerHTML = `
            <div class="toast-content">
                <span class="toast-message">${message}</span>
                <button class="toast-close" onclick="this.parentElement.parentElement.remove()">âœ•</button>
            </div>
        `;
        container.appendChild(toast);

        // Auto-remove after 5 seconds
        setTimeout(() => {
            toast.style.animation = 'fadeOut 0.5s ease-in forwards';
            setTimeout(() => toast.remove(), 500);
        }, 5000);
    }



    // Simple toast notification function
    function showToast(message, type = 'info') {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast toast-${type} show`;
        toast.innerHTML = `
        <div class="toast-content">
            <span class="toast-message">${message}</span>
            <button class="toast-close" onclick="this.parentElement.parentElement.remove()">âœ•</button>
        </div>
    `;
        container.appendChild(toast);

        setTimeout(() => {
            toast.style.animation = 'fadeOut 0.5s ease-in forwards';
            setTimeout(() => toast.remove(), 500);
        }, 5000);
    }

    // Achievement Popup Function
    function showAchievementPopup(achievements) {
        achievements.forEach((achievement, index) => {
            setTimeout(() => {
                // Create popup element
                const popup = document.createElement('div');
                popup.className = 'achievement-popup';
                popup.innerHTML = `
                <div class="popup-content">
                    <div class="popup-icon">${achievement.icon}</div>
                    <div class="popup-info">
                        <div class="popup-badge">ğŸ† Achievement Unlocked!</div>
                        <div class="popup-name">${achievement.name}</div>
                        <div class="popup-description">${achievement.description}</div>
                        <div class="popup-points">+${achievement.points} points</div>
                    </div>
                </div>
            `;

                document.body.appendChild(popup);

                // Animate in
                setTimeout(() => {
                    popup.classList.add('show');
                }, 100);

                // Remove after 5 seconds
                setTimeout(() => {
                    popup.classList.remove('show');
                    setTimeout(() => {
                        popup.remove();
                    }, 500);
                }, 5000);
            }, index * 500); // Stagger multiple achievements
        });
    }

    // Simple toast notification function (keep existing)
    function showToast(message, type = 'info') {
        let toast = document.getElementById('toast');
        if (!toast) {
            toast = document.createElement('div');
            toast.id = 'toast';
            toast.className = 'toast';
            document.body.appendChild(toast);
        }

        toast.textContent = message;
        toast.className = `toast toast-${type} show`;

        setTimeout(() => {
            toast.classList.remove('show');
        }, 3000);
    }



    // Web Share API for tasks
    async function shareTask(taskId, taskTitle, priority) {
        const shareData = {
            title: 'Quantum Manager - My Task',
            text: `ğŸ“‹ ${taskTitle}\nâš¡ Priority: ${priority}\n\nCheck out my task on Quantum manager!`,
            url: window.location.origin + '/'
        };

        try {
            // Check if Web Share API is supported
            if (navigator.share) {
                await navigator.share(shareData);
                showToast('âœ… Task shared successfully!', 'success');
            } else {
                // Fallback: Copy to clipboard
                const textToCopy = `${shareData.text}\n\n${shareData.url}`;
                await navigator.clipboard.writeText(textToCopy);
                showToast('âœ… Task details copied to clipboard!', 'success');
            }
        } catch (err) {
            if (err.name !== 'AbortError') {
                console.error('Share failed:', err);
                showToast('âŒ Failed to share task', 'error');
            }
        }
    }

    // Share achievement
    async function shareAchievement(achievementName, achievementIcon, points) {
        const shareData = {
            title: 'Quantum Manager - Achievement Unlocked! ğŸ†',
            text: `${achievementIcon} I just unlocked "${achievementName}"!\nâ­ +${points} points\n\nJoin me on Quantum Manager and track your productivity!`,
            url: window.location.origin + '/achievements/'
        };

        try {
            if (navigator.share) {
                await navigator.share(shareData);
                showToast('âœ… Achievement shared!', 'success');
            } else {
                const textToCopy = `${shareData.text}\n\n${shareData.url}`;
                await navigator.clipboard.writeText(textToCopy);
                showToast('âœ… Achievement details copied to clipboard!', 'success');
            }
        } catch (err) {
            if (err.name !== 'AbortError') {
                console.error('Share failed:', err);
            }
        }
    }

    // Share streak
    async function shareStreak(streakDays, longestStreak, totalTasks) {
        const fireEmojis = 'ğŸ”¥'.repeat(Math.min(streakDays, 10));

        const shareData = {
            title: 'Quantum Manager - My Productivity Streak! ğŸ”¥',
            text: `${fireEmojis}\n\nI'm on a ${streakDays}-day streak!\n\nğŸ“Š Stats:\nâœ… ${totalTasks} tasks completed\nğŸ† Longest streak: ${longestStreak} days\n\nStay productive with Quantum Manager!`,
            url: window.location.origin + '/achievements/'
        };

        try {
            if (navigator.share) {
                await navigator.share(shareData);
                showToast('âœ… Streak shared!', 'success');
            } else {
                const textToCopy = `${shareData.text}\n\n${shareData.url}`;
                await navigator.clipboard.writeText(textToCopy);
                showToast('âœ… Streak details copied to clipboard!', 'success');
            }
        } catch (err) {
            if (err.name !== 'AbortError') {
                console.error('Share failed:', err);
            }
        }
    }

    // Share template
    async function shareTemplate(templateName, templateIcon, itemCount) {
        const shareData = {
            title: 'Quantum Manager - Task Template',
            text: `${templateIcon} Check out my "${templateName}" template!\nğŸ“‹ ${itemCount} tasks included\n\nGet organized with Quantumanager!`,
            url: window.location.origin + '/templates/'
        };

        try {
            if (navigator.share) {
                await navigator.share(shareData);
                showToast('âœ… Template shared!', 'success');
            } else {
                const textToCopy = `${shareData.text}\n\n${shareData.url}`;
                await navigator.clipboard.writeText(textToCopy);
                showToast('âœ… Template details copied to clipboard!', 'success');
            }
        } catch (err) {
            if (err.name !== 'AbortError') {
                console.error('Share failed:', err);
            }
        }
    }
</script>

{% endblock %}