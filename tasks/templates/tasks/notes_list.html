{% extends 'tasks/base.html' %}
{% load static %}

{% block title %}My Notes - Quantum Manager{% endblock %}

{% block content %}
<div class="container">
    {% csrf_token %}

    <!-- Page Header -->
    <header class="page-header">
        <h1 class="page-title">
            <span class="glow">ğŸ“ My</span> Notes
        </h1>
        <p style="text-align: center; color: rgba(255, 255, 255, 0.7); margin-top: 10px;">
            Quick notes, memories, and ideas that don't need to be tasks
        </p>
    </header>

    <!-- Stats Container -->
    <div class="stats-container">
        <div class="stat-box">
            <span class="stat-number">{{ total_notes }}</span>
            <span class="stat-label">Total Notes</span>
        </div>
        <div class="stat-box">
            <span class="stat-number">{{ pinned_count }}</span>
            <span class="stat-label">Pinned</span>
        </div>
    </div>

    <!-- Search Bar -->
    <div class="search-container">
        <form action="/notes/" method="GET" class="search-form">
            {% if selected_category %}
            <input type="hidden" name="category" value="{{ selected_category }}">
            {% endif %}

            <div class="search-input-wrapper">
                <span class="search-icon">ğŸ”</span>
                <input type="text" name="search" class="search-input"
                    placeholder="Search notes by title, content, or tags..." value="{{ search_query }}"
                    autocomplete="off">
                {% if search_query %}
                <a href="/notes/" class="clear-search" title="Clear search">âœ•</a>
                {% endif %}
            </div>

            <button type="submit" class="search-btn">
                <span>Search</span>
            </button>
        </form>

        {% if search_query %}
        <div class="search-results-info">
            <p>Found <strong>{{ notes.count }}</strong> result{{ notes.count|pluralize }} for "<strong>{{ search_query
                    }}</strong>"</p>
        </div>
        {% endif %}
    </div>

    <!-- Category Filter -->
    <div class="filter-section">
        <h3 class="filter-title">Filter by Category</h3>
        <div class="filter-buttons">
            <a href="/notes/" class="filter-btn {% if not selected_category %}active{% endif %}">
                <span>ğŸŒŸ</span>
                <span>All Notes</span>
            </a>

            <a href="?category=personal" class="filter-btn {% if selected_category == 'personal' %}active{% endif %}">
                <span>ğŸ‘¤</span>
                <span>Personal</span>
            </a>

            <a href="?category=ideas" class="filter-btn {% if selected_category == 'ideas' %}active{% endif %}">
                <span>ğŸ’¡</span>
                <span>Ideas</span>
            </a>

            <a href="?category=dates" class="filter-btn {% if selected_category == 'dates' %}active{% endif %}">
                <span>ğŸ“…</span>
                <span>Important Dates</span>
            </a>

            <a href="?category=quotes" class="filter-btn {% if selected_category == 'quotes' %}active{% endif %}">
                <span>ğŸ’¬</span>
                <span>Quotes</span>
            </a>

            <a href="?category=reference" class="filter-btn {% if selected_category == 'reference' %}active{% endif %}">
                <span>ğŸ“š</span>
                <span>Reference</span>
            </a>

            <a href="?category=other" class="filter-btn {% if selected_category == 'other' %}active{% endif %}">
                <span>ğŸ”–</span>
                <span>Other</span>
            </a>
        </div>
    </div>

    <!-- Export Button -->
    <div style="text-align: center; margin-bottom: 20px;">
        <a href="/notes/export-all/" class="btn btn-update" style="display: inline-flex;">
            <span>ğŸ“¤</span>
            <span>Export All Notes</span>
        </a>
    </div>

    <!-- Notes Grid (Masonry Layout) -->
    <div class="notes-grid">
        {% for note in notes %}
        <div class="note-card" style="--note-color: {{ note.color }};" data-note-id="{{ note.id }}">
            <!-- Pin Button -->
            <button class="pin-btn {% if note.is_pinned %}pinned{% endif %}" onclick="togglePin({{ note.id }})"
                title="{% if note.is_pinned %}Unpin{% else %}Pin to top{% endif %}">
                ğŸ“Œ
            </button>

            <!-- Note Header -->
            <div class="note-header">
                <h3 class="note-title">{{ note.title }}</h3>
                <span class="note-category">{{ note.get_category_display }}</span>
            </div>

            <!-- Note Content -->
            <div class="note-content">
                {{ note.content|linebreaks }}
            </div>

            <!-- Tags -->
            {% if note.tags %}
            <div class="note-tags">
                {% for tag in note.get_tags_list %}
                <span class="note-tag">{{ tag }}</span>
                {% endfor %}
            </div>
            {% endif %}

            <!-- Note Footer -->
            <div class="note-footer">
                <span class="note-date" title="Created: {{ note.created|date:'M d, Y h:i A' }}">
                    ğŸ• {{ note.created|timesince }} ago
                </span>
                <div class="note-actions">
                    <a href="/notes/{{ note.id }}/update/" class="note-action-btn" title="Edit">
                        âœï¸
                    </a>

                    <a href="/notes/{{ note.id }}/convert-to-task/" class="note-action-btn" title="Convert to Task">
                        âœ…
                    </a>

                    <a href="/notes/{{ note.id }}/archive/" class="note-action-btn" title="Edit">
                        ğŸ“¦
                    </a>
                    <button onclick="shareNote('{{ note.title|escapejs }}', '{{ note.get_category_display }}')"
                        class="note-action-btn" title="Share">
                        ğŸ”—
                    </button>
                    <a href="/notes/{{ note.id }}/delete/" class="note-action-btn" title="Delete">
                        ğŸ—‘ï¸
                    </a>

                    <a href="/notes/{{ note.id }}/export/" class="note-action-btn" title="Export as Text">
                        ğŸ“¥
                    </a>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="empty-state">
            {% if search_query %}
            <div class="no-results">
                <h3>ğŸ” No results found</h3>
                <p>No notes match "<strong>{{ search_query }}</strong>"</p>
                <a href="/notes/" class="btn btn-update" style="margin-top: 20px; display: inline-flex;">
                    <span>Clear Search</span>
                </a>
            </div>
            {% else %}
            <div class="empty-tasks">
                <div class="empty-icon">ğŸ“</div>
                <h3>No notes yet!</h3>
                <p>Click the <strong>+</strong> button below to create your first note</p>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>

<script>
    // Toggle pin status
    function togglePin(noteId) {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        fetch(`/notes/${noteId}/toggle-pin/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const pinBtn = document.querySelector(`[data-note-id="${noteId}"] .pin-btn`);
                    if (data.is_pinned) {
                        pinBtn.classList.add('pinned');
                        pinBtn.title = 'Unpin';
                        showToast('ğŸ“Œ Note pinned to top!', 'success');
                    } else {
                        pinBtn.classList.remove('pinned');
                        pinBtn.title = 'Pin to top';
                        showToast('ğŸ“Œ Note unpinned!', 'info');
                    }
                    // Reload after 1 second to reorder
                    setTimeout(() => location.reload(), 1000);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('âŒ Failed to pin note', 'error');
            });
    }

    // Share note
    async function shareNote(title, category) {
        const shareData = {
            title: 'Quantum Manager - My Note',
            text: `ğŸ“ ${title}\nğŸ“‚ Category: ${category}\n\nCheck out my note on Quantum Manager!`,
            url: window.location.origin + '/notes/'
        };

        try {
            if (navigator.share) {
                await navigator.share(shareData);
                showToast('âœ… Note shared successfully!', 'success');
            } else {
                const textToCopy = `${shareData.text}\n\n${shareData.url}`;
                await navigator.clipboard.writeText(textToCopy);
                showToast('âœ… Note details copied to clipboard!', 'success');
            }
        } catch (err) {
            if (err.name !== 'AbortError') {
                console.error('Share failed:', err);
                showToast('âŒ Failed to share note', 'error');
            }
        }
    }

    // Toast notification
    function showToast(message, type = 'info') {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast toast-${type} show`;
        toast.innerHTML = `
        <div class="toast-content">
            <span class="toast-message">${message}</span>
            <button class="toast-close" onclick="this.parentElement.parentElement.remove()">âœ•</button>
        </div>
    `;
        container.appendChild(toast);

        setTimeout(() => {
            toast.style.animation = 'fadeOut 0.5s ease-in forwards';
            setTimeout(() => toast.remove(), 500);
        }, 5000);
    }
</script>

{% endblock %}