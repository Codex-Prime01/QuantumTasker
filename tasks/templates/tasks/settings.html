{% extends 'tasks/base.html' %}

{% block title %}Settings - Quantum Manager{% endblock %}

{% block content %}
<div class="settings-container">

    <!-- Settings Header -->
    <div class="settings-header">
        <div class="header-content">
            <div class="header-icon">‚öôÔ∏è</div>
            <div class="header-text">
                <h1 class="settings-title">Settings</h1>
                <p class="settings-subtitle">Customize your Quantum Manager experience</p>
            </div>
        </div>
    </div>

    <!-- Tabs Navigation -->
    <div class="tabs-container">
        <div class="tabs-nav">
            <button class="tab-button {% if active_tab == 'notifications' %}active{% endif %}"
                onclick="switchTab('notifications')">
                <span class="tab-icon">üîî</span>
                <span class="tab-label">Notifications</span>
            </button>

            <!--
            <button class="tab-button {% if active_tab == 'appearance' %}active{% endif %}"
                onclick="switchTab('appearance')">
                <span class="tab-icon">üé®</span>
                <span class="tab-label">Appearance</span>
            </button>
        -->

            <button class="tab-button {% if active_tab == 'task_defaults' %}active{% endif %}"
                onclick="switchTab('task_defaults')">
                <span class="tab-icon">üìã</span>
                <span class="tab-label">Task Defaults</span>
            </button>

            <button class="tab-button {% if active_tab == 'privacy' %}active{% endif %}" onclick="switchTab('privacy')">
                <span class="tab-icon">üîí</span>
                <span class="tab-label">Privacy</span>
            </button>

            <button class="tab-button {% if active_tab == 'account' %}active{% endif %}" onclick="switchTab('account')">
                <span class="tab-icon">üë§</span>
                <span class="tab-label">Account</span>
            </button>
        </div>

        <!-- Tab Content -->
        <div class="tabs-content">

            <!-- Notifications Tab -->
            <div class="tab-panel {% if active_tab == 'notifications' %}active{% endif %}" id="notifications-panel">
                <div class="panel-header">
                    <h2 class="panel-title">
                        <span class="panel-icon">üîî</span>
                        <span>Notification Preferences</span>
                    </h2>
                    <p class="panel-description">
                        Control how and when you receive notifications
                    </p>
                </div>

                <form method="POST" class="settings-form">
                    {% csrf_token %}
                    <input type="hidden" name="form_type" value="notifications">

                    <div class="settings-group">
                        <div class="setting-item">
                            <div class="setting-info">
                                <label class="setting-label">
                                    {{ notification_form.email_notifications.label }}
                                    <span class="badge-coming-soon">Coming Soon</span>
                                </label>
                                <p class="setting-description">
                                    {{ notification_form.email_notifications.help_text }}
                                </p>
                            </div>
                            <div class="setting-control">
                                <label class="toggle-switch">
                                    {{ notification_form.email_notifications }}
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>

                        <div class="setting-item">
                            <div class="setting-info">
                                <label class="setting-label">
                                    {{ notification_form.email_daily_summary.label }}
                                    <span class="badge-coming-soon">Coming Soon</span>
                                </label>
                                <p class="setting-description">
                                    {{ notification_form.email_daily_summary.help_text }}
                                </p>
                            </div>
                            <div class="setting-control">
                                <label class="toggle-switch">
                                    {{ notification_form.email_daily_summary }}
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>

                        <div class="setting-item">
                            <div class="setting-info">
                                <label class="setting-label">
                                    {{ notification_form.email_task_reminders.label }}
                                    <span class="badge-coming-soon">Coming Soon</span>
                                </label>
                                <p class="setting-description">
                                    {{ notification_form.email_task_reminders.help_text }}
                                </p>
                            </div>
                            <div class="setting-control">
                                <label class="toggle-switch">
                                    {{ notification_form.email_task_reminders }}
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>

                        <div class="setting-item">
                            <div class="setting-info">
                                <label class="setting-label">
                                    {{ notification_form.browser_notifications.label }}
                                    <span class="badge-coming-soon">Coming Soon</span>
                                </label>
                                <p class="setting-description">
                                    {{ notification_form.browser_notifications.help_text }}
                                </p>
                            </div>
                            <div class="setting-control">
                                <label class="toggle-switch">
                                    {{ notification_form.browser_notifications }}
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary btn-save">
                        <span>üíæ</span>
                        <span>Save Notification Settings</span>
                    </button>
                </form>
            </div>

            <!-- Appearance Tab 
            <div class="tab-panel {% if active_tab == 'appearance' %}active{% endif %}" id="appearance-panel">
                <div class="panel-header">
                    <h2 class="panel-title">
                        <span class="panel-icon">üé®</span>
                        <span>Appearance Settings</span>
                    </h2>
                    <p class="panel-description">
                        Customize how Todo Manager looks
                    </p>
                </div>

                <form method="POST" class="settings-form" id="appearanceForm">
                    {% csrf_token %}
                    <input type="hidden" name="form_type" value="appearance">

                    <div class="settings-group">
                        <div class="setting-item-vertical">
                            <div class="setting-info">
                                <label class="setting-label">
                                    {{ appearance_form.theme.label }}
                                </label>
                                <p class="setting-description">
                                    {{ appearance_form.theme.help_text }}
                                </p>
                            </div>
                            <div class="theme-options">
                                {% for choice in appearance_form.theme %}
                                <label class="theme-card" data-theme-value="{{ choice.choice_value }}">
                                    {{ choice.tag }}
                                    <div class="theme-preview theme-{{ choice.choice_label|lower }}">
                                        <div class="preview-header"></div>
                                        <div class="preview-content">
                                            <div class="preview-line"></div>
                                            <div class="preview-line short"></div>
                                            <div class="preview-line"></div>
                                        </div>
                                    </div>
                                    <span class="theme-name">
                                        {% if choice.choice_label == 'Dark' %}üåô
                                        {% elif choice.choice_label == 'Light' %}‚òÄÔ∏è
                                        {% else %}üåì{% endif %}
                                        {{ choice.choice_label }}
                                    </span>
                                    {% if choice.choice_label == 'Auto' %}
                                    <span class="badge-coming-soon">Soon</span>
                                    {% endif %}
                                </label>
                                {% endfor %}
                            </div>
                        </div>

                        <div class="setting-item-vertical">
                            <div class="setting-info">
                                <label class="setting-label" for="{{ appearance_form.date_format.id_for_label }}">
                                    {{ appearance_form.date_format.label }}
                                </label>
                                <p class="setting-description">
                                    {{ appearance_form.date_format.help_text }}
                                </p>
                            </div>
                            <div class="setting-control-full">
                                {{ appearance_form.date_format }}
                            </div>
                        </div>
                    -->

            <!-- üëá NEW! Live preview toggle 
                        <div class="setting-item">
                            <div class="setting-info">
                                <label class="setting-label">
                                    Live Preview
                                </label>
                                <p class="setting-description">
                                    See changes before saving
                                </p>
                            </div>
                            <div class="setting-control">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="livePreview" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary btn-save">
                        <span>üíæ</span>
                        <span>Save Appearance Settings</span>
                    </button>
                </form>
            </div> -->
            <!-- Task Defaults Tab -->
            <div class="tab-panel {% if active_tab == 'task_defaults' %}active{% endif %}" id="task_defaults-panel">
                <div class="panel-header">
                    <h2 class="panel-title">
                        <span class="panel-icon">üìã</span>
                        <span>Task Defaults</span>
                    </h2>
                    <p class="panel-description">
                        Set default values for new tasks
                    </p>
                </div>

                <form method="POST" class="settings-form">
                    {% csrf_token %}
                    <input type="hidden" name="form_type" value="task_defaults">

                    <div class="settings-group">
                        <div class="setting-item-vertical">
                            <div class="setting-info">
                                <label class="setting-label"
                                    for="{{ task_defaults_form.default_priority.id_for_label }}">
                                    {{ task_defaults_form.default_priority.label }}
                                </label>
                                <p class="setting-description">
                                    {{ task_defaults_form.default_priority.help_text }}
                                </p>
                            </div>
                            <div class="setting-control-full">
                                {{ task_defaults_form.default_priority }}
                            </div>
                        </div>

                        <div class="setting-item-vertical">
                            <div class="setting-info">
                                <label class="setting-label"
                                    for="{{ task_defaults_form.default_category.id_for_label }}">
                                    {{ task_defaults_form.default_category.label }}
                                </label>
                                <p class="setting-description">
                                    {{ task_defaults_form.default_category.help_text }}
                                </p>
                            </div>
                            <div class="setting-control-full">
                                {{ task_defaults_form.default_category }}
                            </div>
                        </div>

                        <div class="setting-item-vertical">
                            <div class="setting-info">
                                <label class="setting-label" for="{{ task_defaults_form.tasks_per_page.id_for_label }}">
                                    {{ task_defaults_form.tasks_per_page.label }}
                                </label>
                                <p class="setting-description">
                                    {{ task_defaults_form.tasks_per_page.help_text }}
                                </p>
                            </div>
                            <div class="setting-control-full">
                                {{ task_defaults_form.tasks_per_page }}
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary btn-save">
                        <span>üíæ</span>
                        <span>Save Task Defaults</span>
                    </button>
                </form>
            </div>

            <!-- Privacy Tab -->
            <div class="tab-panel {% if active_tab == 'privacy' %}active{% endif %}" id="privacy-panel">
                <div class="panel-header">
                    <h2 class="panel-title">
                        <span class="panel-icon">üîí</span>
                        <span>Privacy Settings</span>
                    </h2>
                    <p class="panel-description">
                        Control your privacy and data sharing
                    </p>
                </div>

                <form method="POST" class="settings-form">
                    {% csrf_token %}
                    <input type="hidden" name="form_type" value="privacy">

                    <div class="settings-group">
                        <div class="setting-item">
                            <div class="setting-info">
                                <label class="setting-label">
                                    {{ privacy_form.show_email.label }}
                                    <span class="badge-coming-soon">Future Feature</span>
                                </label>
                                <p class="setting-description">
                                    {{ privacy_form.show_email.help_text }}
                                </p>
                            </div>
                            <div class="setting-control">
                                <label class="toggle-switch">
                                    {{ privacy_form.show_email }}
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>

                        <div class="setting-item">
                            <div class="setting-info">
                                <label class="setting-label">
                                    {{ privacy_form.allow_shared_lists.label }}
                                    <span class="badge-coming-soon">Future Feature</span>
                                </label>
                                <p class="setting-description">
                                    {{ privacy_form.allow_shared_lists.help_text }}
                                </p>
                            </div>
                            <div class="setting-control">
                                <label class="toggle-switch">
                                    {{ privacy_form.allow_shared_lists }}
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary btn-save">
                        <span>üíæ</span>
                        <span>Save Privacy Settings</span>
                    </button>
                </form>
            </div>

            <!-- Account Tab -->
            <div class="tab-panel {% if active_tab == 'account' %}active{% endif %}" id="account-panel">
                <div class="panel-header">
                    <h2 class="panel-title">
                        <span class="panel-icon">üë§</span>
                        <span>Account Management</span>
                    </h2>
                    <p class="panel-description">
                        Manage your account settings
                    </p>
                </div>

                <div class="settings-group">
                    <!-- Account Info -->
                    <div class="info-card">
                        {% if request.user.profile.get_avatar_url %}
                        <img src="{{ request.user.profile.get_avatar_url }}" alt="{{ request.user.username }}"
                            class="profile-avatar has-image">
                        {% else %}
                        <div class="user-avatar">
                            {{ request.user.username|upper|slice:":2"|default:"?" }}
                        </div>
                        <div class="avatar-badge">
                            {% if request.user.profile.email_verified %}
                            <span class="verified-badge" title="Email Verified">‚úì</span>
                            {% else %}
                            <span class="unverified-badge" title="Email Not Verified">!</span>
                            {% endif %}
                        </div>
                        {% endif %}
                        <div class="info-content">
                            <h3 class="info-title">Account Information</h3>
                            <div class="info-details">
                                <p><strong>Username:</strong> {{ request.user.username }}</p>
                                <p><strong>Email:</strong> {{ request.user.email }}</p>
                                <p><strong>Member Since:</strong> {{ request.user.date_joined|date:"F d, Y" }}</p>
                                <p><strong>Email Verified:</strong>
                                    {% if request.user.profile.email_verified %}
                                    <span class="status-verified">‚úÖ Verified</span>
                                    {% else %}
                                    <span class="status-unverified">‚ö†Ô∏è Not Verified</span>
                                    <a href="/resend-verification/" class="link-inline">Verify Now</a>
                                    {% endif %}
                                </p>
                            </div>
                            <a href="/profile/" class="btn btn-update btn-small">
                                <span>‚úèÔ∏è</span>
                                <span>Edit Profile</span>
                            </a>
                        </div>
                    </div>

                    <!-- Delete Account -->
                    <div class="danger-zone">
                        <div class="danger-header">
                            <h3 class="danger-title">‚ö†Ô∏è Danger Zone</h3>
                            <p class="danger-description">
                                Permanently delete your account and all associated data
                            </p>
                        </div>

                        <button type="button" class="btn btn-danger" onclick="showDeleteModal()">
                            <span>üóëÔ∏è</span>
                            <span>Delete Account</span>
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Back Button -->
    <div class="settings-footer">
        <a href="/" class="btn btn-secondary">
            <span>‚Üê</span>
            <span class="text1">Back to Tasks</span>
        </a>
    </div>
</div>

<!-- Delete Account Modal -->
<div class="modal-overlay" id="deleteModal">
    <div class="modal-content modal-danger">
        <div class="modal-header">
            <h2 class="modal-title">‚ö†Ô∏è Delete Account</h2>
            <button class="modal-close" onclick="closeDeleteModal()">‚úï</button>
        </div>

        <div class="modal-body">
            <div class="warning-box">
                <p><strong>This action cannot be undone!</strong></p>
                <p>Deleting your account will:</p>
                <ul>
                    <li>‚ùå Permanently delete all your tasks</li>
                    <li>‚ùå Remove all your categories</li>
                    <li>‚ùå Delete your profile and settings</li>
                    <li>‚ùå Remove all associated data</li>
                </ul>
            </div>

            <form method="POST" id="deleteAccountForm">
                {% csrf_token %}
                <input type="hidden" name="form_type" value="delete_account">

                <div class="form-group">
                    <label class="form-label">
                        Type your username to confirm:
                    </label>
                    <input type="text" name="confirm_delete" class="form-input" placeholder="Enter your username"
                        required autocomplete="off">
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeDeleteModal()">
                        <span>Cancel</span>
                    </button>
                    <button type="submit" class="btn btn-danger">
                        <span>üóëÔ∏è</span>
                        <span>Delete My Account</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Tab Switching
    function switchTab(tabName) {
        // Update URL without reload
        const url = new URL(window.location);
        url.searchParams.set('tab', tabName);
        window.history.pushState({}, '', url);

        // Hide all panels
        document.querySelectorAll('.tab-panel').forEach(panel => {
            panel.classList.remove('active');
        });

        // Hide all tab buttons
        document.querySelectorAll('.tab-button').forEach(button => {
            button.classList.remove('active');
        });

        // Show selected panel
        document.getElementById(tabName + '-panel').classList.add('active');

        // Highlight selected button
        event.target.closest('.tab-button').classList.add('active');
    }

    // Delete Account Modal
    function showDeleteModal() {
        document.getElementById('deleteModal').classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function closeDeleteModal() {
        document.getElementById('deleteModal').classList.remove('active');
        document.body.style.overflow = 'auto';
    }

    // Close modal on overlay click
    document.getElementById('deleteModal').addEventListener('click', function (e) {
        if (e.target === this) {
            closeDeleteModal();
        }
    });

    // Close modal on ESC key
    document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
            closeDeleteModal();
        }
    });


    // Theme Switcher with Live Preview
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('appearanceForm');
        const themeCards = document.querySelectorAll('.theme-card');
        const livePreviewToggle = document.getElementById('livePreview');
        let originalTheme = document.documentElement.getAttribute('data-theme');

        // Theme card click handler
        themeCards.forEach(card => {
            const radio = card.querySelector('input[type="radio"]');

            card.addEventListener('click', function () {
                // Check the radio
                radio.checked = true;

                // Live preview if enabled
                if (livePreviewToggle.checked) {
                    const themeValue = card.getAttribute('data-theme-value');
                    if (themeValue !== 'auto') {  // Auto not implemented yet
                        applyTheme(themeValue);
                    }
                }
            });
        });

        // Apply theme function
        function applyTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);

            // Add smooth transition class
            document.body.classList.add('theme-transitioning');

            setTimeout(() => {
                document.body.classList.remove('theme-transitioning');
            }, 300);
        }

        // Form submit - save permanently
        form.addEventListener('submit', function (e) {
            // Form will submit normally and save to database
            // No need to prevent default
        });

        // Cancel/navigation - restore original theme if not saved
        window.addEventListener('beforeunload', function () {
            const selectedTheme = form.querySelector('input[name="theme"]:checked')?.value;
            if (livePreviewToggle.checked && selectedTheme && !form.submitted) {
                // Restore original theme if leaving without saving
                // (This is just visual, actual saved theme unchanged)
            }
        });
    });
</script>
{% endblock %}