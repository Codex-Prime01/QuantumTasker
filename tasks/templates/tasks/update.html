{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Update Task</title>
    <link rel="stylesheet" href="{% static 'tasks/style.css' %}">
</head>

<body>

    <body>
        <!-- Toast Notifications Container -->
        <div class="toast-container" id="toastContainer">
            {% if messages %}
            {% for message in messages %}
            <div class="toast toast-{{ message.tags }} show" role="alert">
                <div class="toast-content">
                    <span class="toast-message">{{ message }}</span>
                    <button class="toast-close" onclick="this.parentElement.parentElement.remove()">‚úï</button>
                </div>
            </div>
            {% endfor %}
            {% endif %}
        </div>

        <!-- Rest of your page content -->

        <div class="container">
            <header>
                <h1 class="title">
                    <span class="glow">Update</span>
                </h1>
            </header>

            <div class="centerColumn">
                <div class="update-form-wrapper">
                    <form action="" method="POST" class="update-form">
                        {% csrf_token %}

                        <div class="form-group">
                            <label for="id_title" class="form-label">Task Title</label>
                            {{ form.title }}
                        </div>

                        <div class="form-group">
                            <label for="id_description" class="form-label">Description</label>
                            {{ form.description }}
                        </div>

                        <!-- üëá NEW! Due Date & Priority -->
                        <div class="form-row">
                            <div class="form-group">
                                <label for="id_due_date" class="form-label">Due Date</label>
                                {{ form.due_date }}
                            </div>

                            <div class="form-group">
                                <label for="id_priority" class="form-label">Priority</label>
                                {{ form.priority }}
                            </div>
                        </div>


                        <div class="form-group">
                            <label class="form-label">Categories (optional)</label>
                            <div class="select-wrapper">
                                {{ form.categories }}
                                <span class="select-arrow"></span>
                            </div>
                            <div class="selected-categories-preview" id="selected-preview">
                                <!-- Selected categories will appear here as tags here -->
                            </div>
                        </div>


                        <div class="form-group full-width recurring-section">
                            <div class="recurring-header">
                                <label class="form-label">
                                    <span class="label-icon">üîÑ</span>
                                    <span>Recurring Task</span>
                                </label>
                                <label class="toggle-switch">
                                    {{ form.is_recurring }}
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <p class="form-hint">{{ form.is_recurring.help_text }}</p>

                            <div class="recurring-options" id="recurringOptions" style="display: none;">
                                <div class="form-group">
                                    <label class="form-label" for="{{ form.recurring_frequency.id_for_label }}">
                                        <span class="label-icon">üìÖ</span>
                                        <span>{{ form.recurring_frequency.label }}</span>
                                    </label>
                                    {{ form.recurring_frequency }}
                                    <p class="form-hint">{{ form.recurring_frequency.help_text }}</p>
                                </div>

                                <div class="form-group" id="customIntervalGroup" style="display: none;">
                                    <label class="form-label" for="{{ form.recurring_interval.id_for_label }}">
                                        <span class="label-icon">üî¢</span>
                                        <span>{{ form.recurring_interval.label }}</span>
                                    </label>
                                    {{ form.recurring_interval }}
                                    <p class="form-hint">{{ form.recurring_interval.help_text }}</p>
                                </div>

                                <div class="recurring-preview">
                                    <p class="preview-text" id="recurringPreview">
                                        <strong>Preview:</strong> <span id="previewText">Task will repeat daily</span>
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div class="form-section alarm-section">
                            <div class="section-header">
                                <h3 class="section-title">
                                    <span class="section-icon">‚è∞</span>
                                    <span>Alarm & Notifications</span>
                                </h3>
                                <p class="section-subtitle">Get notified when this task is due</p>
                            </div>

                            <!-- Enable Alarm Toggle -->
                            <div class="form-group toggle-group">
                                <label class="toggle-label">
                                    <input type="checkbox" 
                                        name="alarm_enabled" 
                                        id="id_alarm_enabled"
                                        {% if form.alarm_enabled.value %}checked{% endif %}
                                        class="toggle-input"
                                        onchange="toggleAlarmSettings()">
                                    <span class="toggle-slider"></span>
                                    <span class="toggle-text">Enable Alarm</span>
                                </label>
                                <p class="field-help">Get browser notification and sound when due</p>
                            </div>

                            <!-- Alarm Settings (shown when enabled) -->
                            <div id="alarm-settings" style="display: none;">
                                <!-- Alarm Time -->
                                <div class="form-group">
                                    <label for="id_alarm_time" class="form-label">
                                        üïê Alarm Time
                                    </label>
                                    {{ form.alarm_time }}
                                    <p class="field-help">When should we remind you?</p>
                                </div>

                                <!-- Alarm Tone Selection -->
                                <div class="form-group">
                                    <label class="form-label">üîî Alarm Sound</label>
                                    <div class="alarm-tone-grid">
                                        <div class="tone-option">
                                            <input type="radio" 
                                                name="alarm_tone" 
                                                value="classic" 
                                                id="tone-classic"
                                                {% if form.alarm_tone.value == 'classic' or not form.alarm_tone.value %}checked{% endif %}>
                                            <label for="tone-classic" class="tone-card">
                                                <div class="tone-icon">‚è∞</div>
                                                <div class="tone-name">Classic Alarm</div>
                                                <div class="tone-desc">Traditional beep beep</div>
                                                <button type="button" class="tone-preview" onclick="previewTone('classic')">
                                                    ‚ñ∂Ô∏è Preview
                                                </button>
                                            </label>
                                        </div>

                                        <div class="tone-option">
                                            <input type="radio" 
                                                name="alarm_tone" 
                                                value="chime" 
                                                id="tone-chime"
                                                {% if form.alarm_tone.value == 'chime' %}checked{% endif %}>
                                            <label for="tone-chime" class="tone-card">
                                                <div class="tone-icon">üéµ</div>
                                                <div class="tone-name">Soft Chime</div>
                                                <div class="tone-desc">Pleasant melody</div>
                                                <button type="button" class="tone-preview" onclick="previewTone('chime')">
                                                    ‚ñ∂Ô∏è Preview
                                                </button>
                                            </label>
                                        </div>

                                        <div class="tone-option">
                                            <input type="radio" 
                                                name="alarm_tone" 
                                                value="urgent" 
                                                id="tone-urgent"
                                                {% if form.alarm_tone.value == 'urgent' %}checked{% endif %}>
                                            <label for="tone-urgent" class="tone-card">
                                                <div class="tone-icon">üö®</div>
                                                <div class="tone-name">Urgent Alert</div>
                                                <div class="tone-desc">Loud & attention-grabbing</div>
                                                <button type="button" class="tone-preview" onclick="previewTone('urgent')">
                                                    ‚ñ∂Ô∏è Preview
                                                </button>
                                            </label>
                                        </div>

                                        <div class="tone-option">
                                            <input type="radio" 
                                                name="alarm_tone" 
                                                value="custom" 
                                                id="tone-custom"
                                                {% if form.alarm_tone.value == 'custom' %}checked{% endif %}>
                                            <label for="tone-custom" class="tone-card">
                                                <div class="tone-icon">üìÅ</div>
                                                <div class="tone-name">Custom Upload</div>
                                                <div class="tone-desc">Use your own sound</div>
                                                <input type="file" 
                                                    accept="audio/*" 
                                                    id="custom-tone-upload"
                                                    style="display: none;"
                                                    onchange="handleCustomToneUpload(this)">
                                                <button type="button" class="tone-preview" onclick="document.getElementById('custom-tone-upload').click()">
                                                    üì§ Upload
                                                </button>
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <!-- Quick Alarm Presets -->
                                <div class="form-group">
                                    <label class="form-label">‚ö° Quick Presets</label>
                                    <div class="alarm-presets">
                                        <button type="button" class="preset-btn" onclick="setAlarmPreset('due')">
                                            <span>üìÖ</span>
                                            <span>At Due Time</span>
                                        </button>
                                        <button type="button" class="preset-btn" onclick="setAlarmPreset('15min')">
                                            <span>‚è∞</span>
                                            <span>15 min before</span>
                                        </button>
                                        <button type="button" class="preset-btn" onclick="setAlarmPreset('30min')">
                                            <span>‚è∞</span>
                                            <span>30 min before</span>
                                        </button>
                                        <button type="button" class="preset-btn" onclick="setAlarmPreset('1hour')">
                                            <span>‚è∞</span>
                                            <span>1 hour before</span>
                                        </button>
                                        <button type="button" class="preset-btn" onclick="setAlarmPreset('1day')">
                                            <span>üìÜ</span>
                                            <span>1 day before</span>
                                        </button>
                                    </div>
                                </div>

                                <!-- Notification Permission Check -->
                                <div id="notification-permission-warning" class="alert alert-warning" style="display: none;">
                                    <strong>‚ö†Ô∏è Notification Permission Required</strong>
                                    <p>Please allow notifications to receive alarms</p>
                                    <button type="button" class="btn btn-sm" onclick="requestNotificationPermission()">
                                        Enable Notifications
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="id_complete" class="checkbox-label">
                                {{ form.complete }}
                                <span class="checkbox-custom"></span>
                                <span class="checkbox-text">Mark as Complete</span>
                            </label>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn btn-update">
                                <span>üíæ</span>
                                <span>Update Task</span>
                            </button>
                            <a href="/" class="btn btn-cancel">
                                <span>‚ùå</span>
                                <span>Cancel</span>
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <script>
            // Show loading overlay when form is submitted
            document.addEventListener('DOMContentLoaded', function () {
                const forms = document.querySelectorAll('form');
                const loadingOverlay = document.getElementById('loadingOverlay');

                forms.forEach(form => {
                    form.addEventListener('submit', function (e) {
                        // Show loading overlay
                        if (loadingOverlay) {
                            loadingOverlay.classList.add('active');
                        }

                        // Add loading class to submit button
                        const submitBtn = form.querySelector('button[type="submit"], input[type="submit"]');
                        if (submitBtn) {
                            submitBtn.classList.add('loading');
                            submitBtn.disabled = true;
                        }
                    });
                });

                // Auto-hide toasts after 5 seconds
                const toasts = document.querySelectorAll('.toast');
                toasts.forEach(toast => {
                    setTimeout(() => {
                        toast.style.animation = 'fadeOut 0.5s ease-in forwards';
                        setTimeout(() => toast.remove(), 500);
                    }, 5000);
                });
            });
 

            document.addEventListener('DOMContentLoaded', function () {
                const isRecurringToggle = document.getElementById('id_is_recurring');
                const recurringOptions = document.getElementById('recurringOptions');
                const frequencySelect = document.getElementById('id_recurring_frequency');
                const customIntervalGroup = document.getElementById('customIntervalGroup');
                const intervalInput = document.getElementById('id_recurring_interval');
                const previewText = document.getElementById('previewText');

                // Show/hide recurring options
                if (isRecurringToggle) {
                    isRecurringToggle.addEventListener('change', function () {
                        if (this.checked) {
                            recurringOptions.style.display = 'block';
                            updatePreview();
                        } else {
                            recurringOptions.style.display = 'none';
                        }
                    });
                }

                // Show/hide custom interval
                frequencySelect.addEventListener('change', function () {
                    if (this.value === 'custom') {
                        customIntervalGroup.style.display = 'block';
                    } else {
                        customIntervalGroup.style.display = 'none';
                    }
                    updatePreview();
                });

                // Update preview on interval change
                intervalInput.addEventListener('input', updatePreview);

                // Update preview text
                function updatePreview() {
                    const frequency = frequencySelect.value;
                    const interval = intervalInput.value || 1;

                    const previewMap = {
                        'none': 'Task does not repeat',
                        'daily': 'Task will repeat every day',
                        'weekly': 'Task will repeat every week',
                        'biweekly': 'Task will repeat every 2 weeks',
                        'monthly': 'Task will repeat every month',
                        'yearly': 'Task will repeat every year',
                        'custom': `Task will repeat every ${interval} day${interval > 1 ? 's' : ''}`
                    };

                    previewText.textContent = previewMap[frequency] || 'Select a frequency';
                }

                // Check if recurring is already enabled (edit mode)
                if (isRecurringToggle && isRecurringToggle.checked) {
                    recurringOptions.style.display = 'block';
                    if (frequencySelect.value === 'custom') {
                        customIntervalGroup.style.display = 'block';
                    }
                    updatePreview();
                }
            });


            
            // Show/hide alarm settings based on toggle
            function toggleAlarmSettings() {
                const enabled = document.getElementById('id_alarm_enabled').checked;
                const settings = document.getElementById('alarm-settings');
                
                if (enabled) {
                    settings.style.display = 'block';
                    checkNotificationPermission();
                    
                    // Set default alarm time if due date exists and alarm time is empty
                    const dueDateInput = document.getElementById('id_due_date');
                    const alarmTimeInput = document.getElementById('id_alarm_time');
                    
                    if (dueDateInput && dueDateInput.value && !alarmTimeInput.value) {
                        alarmTimeInput.value = dueDateInput.value;
                    }
                } else {
                    settings.style.display = 'none';
                }
            }

            // Check notification permission on page load
            function checkNotificationPermission() {
                if ('Notification' in window && Notification.permission !== 'granted') {
                    document.getElementById('notification-permission-warning').style.display = 'block';
                }
            }

            // Request notification permission
            async function requestNotificationPermission() {
                if ('Notification' in window) {
                    const permission = await Notification.requestPermission();
                    if (permission === 'granted') {
                        document.getElementById('notification-permission-warning').style.display = 'none';
                        showToast('‚úÖ Notifications enabled!', 'success');
                    }
                }
            }

            // Preview alarm tone
            function previewTone(tone) {
                if (typeof alarmSystem !== 'undefined') {
                    alarmSystem.playAlarmSound(tone);
                } else {
                    // Fallback if alarm system not loaded
                    const audio = new Audio();
                    if (tone === 'classic') {
                        // Play a simple beep using data URL
                        audio.src = 'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZSA0PWqvl8KtfGQs+lutRZhB';
                        audio.play();
                    }
                }
            }

            // Set alarm preset
            function setAlarmPreset(preset) {
                const dueDateInput = document.getElementById('id_due_date');
                const alarmTimeInput = document.getElementById('id_alarm_time');
                
                if (!dueDateInput || !dueDateInput.value) {
                    showToast('‚ö†Ô∏è Please set a due date first', 'warning');
                    return;
                }
                
                const dueDate = new Date(dueDateInput.value);
                let alarmDate = new Date(dueDate);
                
                switch(preset) {
                    case 'due':
                        // Same as due date
                        break;
                    case '15min':
                        alarmDate.setMinutes(alarmDate.getMinutes() - 15);
                        break;
                    case '30min':
                        alarmDate.setMinutes(alarmDate.getMinutes() - 30);
                        break;
                    case '1hour':
                        alarmDate.setHours(alarmDate.getHours() - 1);
                        break;
                    case '1day':
                        alarmDate.setDate(alarmDate.getDate() - 1);
                        break;
                }
                
                // Format datetime for input (YYYY-MM-DDTHH:MM)
                const year = alarmDate.getFullYear();
                const month = String(alarmDate.getMonth() + 1).padStart(2, '0');
                const day = String(alarmDate.getDate()).padStart(2, '0');
                const hours = String(alarmDate.getHours()).padStart(2, '0');
                const minutes = String(alarmDate.getMinutes()).padStart(2, '0');
                
                alarmTimeInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;
                showToast('‚úÖ Alarm time set!', 'success');
            }

            // Handle custom tone upload
            function handleCustomToneUpload(input) {
                if (input.files && input.files[0]) {
                    const file = input.files[0];
                    
                    // Check file type
                    if (!file.type.startsWith('audio/')) {
                        showToast('‚ö†Ô∏è Please upload an audio file', 'warning');
                        return;
                    }
                    
                    // Check file size (max 5MB)
                    if (file.size > 5 * 1024 * 1024) {
                        showToast('‚ö†Ô∏è File too large (max 5MB)', 'warning');
                        return;
                    }
                    
                    // Store in localStorage temporarily
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        localStorage.setItem('customAlarmTone', e.target.result);
                        localStorage.setItem('customAlarmToneName', file.name);
                        
                        document.getElementById('tone-custom').checked = true;
                        showToast(`‚úÖ Custom tone "${file.name}" loaded!`, 'success');
                        
                        // Update the custom tone label
                        const customLabel = document.querySelector('label[for="tone-custom"] .tone-name');
                        customLabel.textContent = file.name;
                    };
                    reader.readAsDataURL(file);
                }
            }

            // Toast notification function
            function showToast(message, type = 'info') {
                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                toast.textContent = message;
                toast.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    right: 20px;
                    padding: 15px 25px;
                    background: ${type === 'success' ? '#2ecc71' : type === 'warning' ? '#f39c12' : '#3498db'};
                    color: white;
                    border-radius: 10px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                    z-index: 10000;
                    animation: slideIn 0.3s ease;
                `;
                
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }

            // Initialize on page load
            document.addEventListener('DOMContentLoaded', function() {
                // Show alarm settings if already enabled
                if (document.getElementById('id_alarm_enabled').checked) {
                    toggleAlarmSettings();
                }
                
                // Load custom tone from localStorage if exists
                const customTone = localStorage.getItem('customAlarmTone');
                const customToneName = localStorage.getItem('customAlarmToneName');
                
                if (customTone && customToneName) {
                    const customLabel = document.querySelector('label[for="tone-custom"] .tone-name');
                    if (customLabel) {
                        customLabel.textContent = customToneName;
                    }
                }
            });

            // Add CSS animations
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from {
                        transform: translateX(400px);
                        opacity: 0;
                    }
                    to {
                        transform: translateX(0);
                        opacity: 1;
                    }
                }
                
                @keyframes slideOut {
                    from {
                        transform: translateX(0);
                        opacity: 1;
                    }
                    to {
                        transform: translateX(400px);
                        opacity: 0;
                    }
                }
            `;
            document.head.appendChild(style);

        </script>

    </body>

</html>